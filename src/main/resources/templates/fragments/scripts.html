<!-- Scripts fragment -->
<th:block th:fragment="scripts">
    <!-- Bootstrap JS -->
    <script src="/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core UI Functions -->
    <script>
        "use strict";

        const UI = {
            init: function () {
                this.initTooltips();
                this.initPopovers();
                this.initAutoResize();
                this.initToasts();
                this.initPasswordToggle();
            },

            // Helper functions
            select: function (selector) {
                return document.querySelector(selector);
            },

            selectAll: function (selector) {
                return document.querySelectorAll(selector);
            },

            // Bootstrap Tooltips
            initTooltips: function () {
                const tooltipTriggers = this.selectAll('[data-bs-toggle="tooltip"]');
                tooltipTriggers.forEach(function (element) {
                    new bootstrap.Tooltip(element);
                });
            },

            // Bootstrap Popovers
            initPopovers: function () {
                const popoverTriggers = this.selectAll('[data-bs-toggle="popover"]');
                popoverTriggers.forEach(function (element) {
                    new bootstrap.Popover(element);
                });
            },

            // Auto-resize textareas
            initAutoResize: function () {
                const textareas = this.selectAll('[data-autoresize]');
                textareas.forEach(function (textarea) {
                    const offset = textarea.offsetHeight - textarea.clientHeight;
                    textarea.addEventListener('input', function () {
                        this.style.height = 'auto';
                        this.style.height = this.scrollHeight + offset + 'px';
                    });
                });
            },

            // Toast notifications
            initToasts: function () {
                const toastButtons = this.selectAll('.toast-btn');
                toastButtons.forEach(function (button) {
                    button.addEventListener('click', function () {
                        const targetId = this.dataset.target;
                        const toastElement = document.getElementById(targetId);
                        if (toastElement) {
                            const toast = new bootstrap.Toast(toastElement);
                            toast.show();
                        }
                    });
                });
            },

            // Password visibility toggle
            initPasswordToggle: function () {
                const passwordInputs = this.selectAll('.fakepassword');
                passwordInputs.forEach(function (passwordInput) {
                    const toggleButton = passwordInput.parentElement.querySelector('.fakepasswordicon');
                    if (toggleButton) {
                        toggleButton.addEventListener('click', function () {
                            const type = passwordInput.type === 'password' ? 'text' : 'password';
                            passwordInput.type = type;

                            // Update icon
                            const icon = this.querySelector('i');
                            if (icon) {
                                icon.classList.toggle('bi-eye');
                                icon.classList.toggle('bi-eye-slash');
                            }
                        });
                    }
                });
            }
        };

        // Initialize UI functions when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            UI.init();
        });
    </script>

    <!-- HTMX Indicator Styles -->
    <style>
        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator {
            display: inline;
        }

        .htmx-request.htmx-indicator {
            display: inline;
        }
    </style>

    <!-- HTMX Core Functions -->
    <script>
        "use strict";

        const HTMX = {
            init: function () {
                this.setupCSRF();
                this.setupLoadingIndicators();
                this.setupErrorHandling();
                this.setupTabManagement();
            },

            setupCSRF: function () {
                document.body.addEventListener('htmx:configRequest', function (event) {
                    const csrfToken = document.querySelector('meta[name="_csrf"]');
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

                    if (csrfToken && csrfHeader) {
                        event.detail.headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content');
                    }
                });
            },

            setupLoadingIndicators: function () {
                document.body.addEventListener('htmx:beforeRequest', function (event) {
                    const targetId = event.detail.target?.id;

                    if (targetId === 'post-detail-modal-content') {
                        const loadingElement = document.getElementById('post-detail-loading');
                        if (loadingElement) {
                            loadingElement.style.display = 'block';
                        }
                    } else if (targetId === 'content-area') {
                        const loadingElement = document.getElementById('loading-indicator');
                        if (loadingElement) {
                            loadingElement.style.display = 'block';
                        }
                    }
                });

                document.body.addEventListener('htmx:afterRequest', function (event) {
                    const targetId = event.detail.target?.id;

                    if (targetId === 'post-detail-modal-content') {
                        const loadingElement = document.getElementById('post-detail-loading');
                        if (loadingElement) {
                            loadingElement.style.display = 'none';
                        }

                        if (event.detail.xhr.status === 200) {
                            const modalBody = document.querySelector('#postDetailModal .modal-body');
                            if (modalBody) {
                                modalBody.scrollTop = 0;
                            }

                            setTimeout(() => {
                                const modalLoadedEvent = new CustomEvent('modalContentLoaded');
                                document.dispatchEvent(modalLoadedEvent);
                            }, 100);
                        }
                    } else if (targetId === 'content-area') {
                        const loadingElement = document.getElementById('loading-indicator');
                        if (loadingElement) {
                            loadingElement.style.display = 'none';
                        }
                    }
                });
            },

            setupErrorHandling: function () {
                document.body.addEventListener('htmx:responseError', function (event) {
                    const contentElement = document.getElementById('post-detail-modal-content');
                    if (!contentElement) return;

                    if (event.detail.xhr.status === 403) {
                        contentElement.innerHTML = `
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="bi bi-lock text-danger" style="font-size: 3rem;"></i>
                                </div>
                                <h5 class="text-muted mb-2">로그인이 필요합니다</h5>
                                <p class="text-muted mb-3">게시글을 보려면 로그인해주세요.</p>
                                <a class="btn btn-primary" href="/signin">
                                    <i class="bi bi-box-arrow-in-right me-1"></i>로그인
                                </a>
                            </div>
                        `;
                        return;
                    }

                    contentElement.innerHTML = `
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="text-muted mb-2">게시글을 불러올 수 없습니다</h5>
                            <p class="text-muted mb-3">네트워크 연결을 확인하고 다시 시도해주세요.</p>
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise me-1"></i>새로고침
                            </button>
                        </div>
                    `;
                });
            },

            setupTabManagement: function () {
                document.body.addEventListener('htmx:beforeRequest', function (evt) {
                    if (evt.detail.target?.id === 'content-area') {
                        document.querySelectorAll('.nav-link').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        evt.detail.elt.classList.add('active');
                    }
                });
            }
        };

        // Initialize HTMX functions when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            HTMX.init();

            // Posts 탭 자동 클릭 (my-list.html용)
            const postsTab = document.getElementById('posts-tab');
            if (postsTab) {
                postsTab.click();
            }
        });
    </script>

    <!-- Post Detail Modal Script -->
    <script>
        function removeFocusFromModal() {
            const modalElement = document.getElementById('postDetailModal');
            if (modalElement) {
                modalElement.addEventListener('hide.bs.modal', function () {
                    if (document.activeElement) {
                        document.activeElement.blur();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', removeFocusFromModal);
    </script>

    <!-- Modal Create Post Script -->
    <th:block th:insert="~{post/modal-create-post :: modal-create-post-script}"></th:block>

    <!-- Time Script -->
    <div th:replace="~{fragments/time-script :: timeScript}"></div>
</th:block>
