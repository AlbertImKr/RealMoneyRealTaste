<!-- Scripts fragment -->
<th:block th:fragment="scripts">
    <!-- Bootstrap JS -->
    <script src="/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Theme Functions -->
    <script>
        "use strict";

        const e = {
            init: function () {
                e.toolTipFunc();
                e.popOverFunc();
                e.autoResize();
                e.toasts();
                e.fakePwd();
            },
            isVariableDefined: function (el) {
                return el != null;
            },
            on: function (selectors, type, listener) {
                document.addEventListener("DOMContentLoaded", () => {
                    if (!(selectors instanceof HTMLElement) && selectors !== null) {
                        selectors = document.querySelector(selectors);
                    }
                    selectors.addEventListener(type, listener);
                });
            },
            onAll: function (selectors, type, listener) {
                document.addEventListener("DOMContentLoaded", () => {
                    document.querySelectorAll(selectors).forEach((element) => {
                        if (type.indexOf(',') > -1) {
                            let types = type.split(',');
                            types.forEach((type) => {
                                element.addEventListener(type, listener);
                            });
                        } else {
                            element.addEventListener(type, listener);
                        }
                    });
                });
            },
            select: function (selectors) {
                return document.querySelector(selectors);
            },
            selectAll: function (selectors) {
                return document.querySelectorAll(selectors);
            },

            // Tooltip
            toolTipFunc: function () {
                let tooltipTriggerList = [].slice.call(e.selectAll('[data-bs-toggle="tooltip"]'))
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                });
            },

            // Popover
            popOverFunc: function () {
                let popoverTriggerList = [].slice.call(e.selectAll('[data-bs-toggle="popover"]'))
                popoverTriggerList.map(function (popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl)
                });
            },

            // Auto resize textarea
            autoResize: function () {
                e.selectAll('[data-autoresize]').forEach(function (element) {
                    let offset = element.offsetHeight - element.clientHeight;
                    element.addEventListener('input', function (event) {
                        event.target.style.height = 'auto';
                        event.target.style.height = event.target.scrollHeight + offset + 'px';
                    });
                });
            },

            // Toasts
            toasts: function () {
                if (e.isVariableDefined(e.select('.toast-btn'))) {
                    window.addEventListener('DOMContentLoaded', () => {
                        e.selectAll(".toast-btn").forEach((t) => {
                            t.addEventListener("click", function () {
                                let toastTarget = document.getElementById(t.dataset.target);
                                let toast = new bootstrap.Toast(toastTarget);
                                toast.show();
                            });
                        });
                    });
                }
            },

            // Fake Password
            fakePwd: function () {
                if (e.isVariableDefined(e.select('.fakepassword'))) {
                    const password = e.select('.fakepassword');
                    const toggler = e.select('.fakepasswordicon');

                    const showHidePassword = () => {
                        if (password.type === 'password') {
                            password.setAttribute('type', 'text');
                            toggler.classList.add('fa-eye');
                        } else {
                            toggler.classList.remove('fa-eye');
                            password.setAttribute('type', 'password');
                        }
                    };

                    toggler.addEventListener('click', showHidePassword);
                }
            }
        };

        e.init();
    </script>

    <!-- HTMX Indicator 커스텀 스타일 -->
    <style>
        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator {
            display: inline;
        }

        .htmx-request.htmx-indicator {
            display: inline;
        }
    </style>

    <!-- HTMX 설정 스크립트 -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // HTMX 이벤트 리스너
            document.body.addEventListener('htmx:configRequest', function (event) {
                // CSRF 토큰이 필요한 경우 추가
                const csrfToken = document.querySelector('meta[name="_csrf"]');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

                if (csrfToken && csrfHeader) {
                    event.detail.headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content');
                }
            });

            // HTMX 이벤트 처리 (Post Detail 모달용)
            document.body.addEventListener('htmx:beforeRequest', function (event) {
                if (event.detail.target?.id === 'post-detail-modal-content') {
                    // 요청 시작 시 로딩 표시
                    const loadingElement = document.getElementById('post-detail-loading');
                    if (loadingElement) {
                        loadingElement.style.display = 'block';
                    }
                }
            });

            document.body.addEventListener('htmx:afterRequest', function (event) {
                if (event.detail.target?.id === 'post-detail-modal-content') {
                    // 요청 완료 시 로딩 숨김
                    const loadingElement = document.getElementById('post-detail-loading');
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }

                    // 성공적으로 로드되었으면 스크롤을 최상단으로
                    if (event.detail.xhr.status === 200) {
                        const modalBody = document.querySelector('#postDetailModal .modal-body');
                        if (modalBody) {
                            modalBody.scrollTop = 0;
                        }

                        // 모달 내용이 로드된 후 스크립트 실행
                        setTimeout(() => {
                            // 모달 전용 스크립트들이 실행되도록 이벤트 발생
                            const modalLoadedEvent = new CustomEvent('modalContentLoaded');
                            document.dispatchEvent(modalLoadedEvent);
                        }, 100);
                    }
                }
            });

            // 간단한 에러 처리만 남김
            document.body.addEventListener('htmx:responseError', function (event) {
                const contentElement = document.getElementById('post-detail-modal-content');
                if (event.detail.xhr.status === 403) {
                    contentElement.innerHTML = `
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="bi bi-lock text-danger" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="text-muted mb-2">로그인이 필요합니다</h5>
                            <p class="text-muted mb-3">게시글을 보려면 로그인해주세요.</p>
                            <a class="btn btn-primary" href="/signin">
                                <i class="bi bi-box-arrow-in-right me-1"></i>로그인
                            </a>
                        </div>
                    `;
                    return;
                }
                contentElement.innerHTML = `
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                            </div>
                            <h5 class="text-muted mb-2">게시글을 불러올 수 없습니다</h5>
                            <p class="text-muted mb-3">로그인 후 다시 시도 혹은 새로고침을 눌러주세요.</p>
                            <button class="btn btn-primary" onclick="location.href='/signin'">
                                <i class="bi bi-box-arrow-in-right me-1"></i>로그인
                            </button>
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise me-1"></i>새로고침
                            </button>
                        </div>
                    `;
            });
        });
    </script>

    <!-- Post Detail Modal Script -->
    <script>
        function removeFocusFromModal() {
            const modalElement = document.getElementById('postDetailModal');
            if (modalElement) {
                // 모달이 닫히기 시작할 때 (중요!)
                modalElement.addEventListener('hide.bs.modal', function () {
                    if (document.activeElement) {
                        document.activeElement.blur();
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', removeFocusFromModal);
    </script>

    <!-- Modal Create Post Script -->
    <th:block th:insert="~{post/modal-create-post :: modal-create-post-script}"></th:block>

    <!-- Time Script -->
    <div th:replace="~{fragments/time-script :: timeScript}"></div>
</th:block>
