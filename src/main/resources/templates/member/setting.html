<!DOCTYPE html>
<html lang="ko">

<head>
    <title>RMRT - Settings</title>

    <!-- Meta Tags -->
    <th:block th:replace="~{fragments/meta-tags :: default-meta}"></th:block>

    <!-- Styles -->
    <th:block th:replace="~{fragments/head :: styles}"></th:block>

    <!-- Core Scripts -->
    <th:block th:replace="~{fragments/head :: core-scripts}"></th:block>
</head>

<body>

<!-- Header START -->
<header th:replace="~{fragments/header :: header}"></header>
<!-- Header END -->

<!-- MAIN CONTENT START -->
<main>
    <!-- Container START -->
    <div class="container">
        <div class="row vh-100">

            <!-- Sidenav START -->
            <div class="col-lg-3">
                <!-- Advanced filter responsive toggler START -->
                <div class="d-flex align-items-center mb-4 d-lg-none">
                    <button aria-controls="offcanvasNavbar" class="border-0 bg-transparent"
                            data-bs-target="#offcanvasNavbar"
                            data-bs-toggle="offcanvas" type="button">
                        <span class="btn btn-primary"><i class="fa-solid fa-sliders-h"></i></span>
                        <span class="h6 mb-0 fw-bold d-lg-none ms-2">설정</span>
                    </button>
                </div>
                <!-- Advanced filter responsive toggler END -->

                <nav aria-label="설정 메뉴" class="navbar navbar-light navbar-expand-lg mx-0">
                    <div aria-labelledby="offcanvasNavbarLabel" class="offcanvas offcanvas-start" id="offcanvasNavbar"
                         tabindex="-1">
                        <!-- Offcanvas header -->
                        <div class="offcanvas-header">
                            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">설정 메뉴</h5>
                            <button aria-label="닫기" class="btn-close" data-bs-dismiss="offcanvas"
                                    type="button"></button>
                        </div>

                        <!-- Offcanvas body -->
                        <div class="offcanvas-body p-0">
                            <!-- Card START -->
                            <div class="card w-100">
                                <!-- Card body START -->
                                <div class="card-body">
                                    <!-- Side Nav START -->
                                    <ul class="nav nav-tabs nav-pills nav-pills-soft flex-column fw-bold gap-2 border-0">
                                        <li class="nav-item" data-bs-dismiss="offcanvas">
                                            <button class="nav-link d-flex mb-0 active border-0 w-100 text-start"
                                                    data-bs-target="#nav-setting-tab-account" data-bs-toggle="tab"
                                                    type="button">
                                                <img alt="계정 설정"
                                                     class="me-2 h-20px fa-fw"
                                                     th:src="@{/assets/images/icon/person-outline-filled.svg}">
                                                <span>계정 설정</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" data-bs-dismiss="offcanvas">
                                            <button class="nav-link d-flex mb-0 border-0 w-100 text-start"
                                                    data-bs-target="#nav-setting-tab-password" data-bs-toggle="tab"
                                                    type="button">
                                                <img alt="비밀번호 변경"
                                                     class="me-2 h-20px fa-fw"
                                                     th:src="@{/assets/images/icon/lock-outline-filled.svg}">
                                                <span>비밀번호 변경</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" data-bs-dismiss="offcanvas">
                                            <button class="nav-link d-flex mb-0 border-0 w-100 text-start"
                                                    data-bs-target="#nav-setting-tab-delete"
                                                    data-bs-toggle="tab" type="button">
                                                <img alt="계정 삭제"
                                                     class="me-2 h-20px fa-fw"
                                                     th:src="@{/assets/images/icon/trash-var-outline-filled.svg}">
                                                <span>계정 삭제</span>
                                            </button>
                                        </li>
                                    </ul>
                                    <!-- Side Nav END -->
                                </div>
                                <!-- Card body END -->
                            </div>
                            <!-- Card END -->
                        </div>
                        <!-- Offcanvas body -->

                        <!-- Copyright -->
                        <p class="small text-center mt-1">©2025 <a class="text-reset"
                                                                   href="https://github.com/AlbertImKr"
                                                                   rel="noopener" target="_blank">
                            RealMoneyRealTaste </a></p>

                    </div>
                </nav>
            </div>
            <!-- Sidenav END -->

            <!-- Main content START -->
            <div class="col-lg-6 vstack gap-4">
                <!-- Account Activation Alert START -->
                <div class="alert alert-warning alert-dismissible fade show d-flex align-items-center" role="alert"
                     th:if="${member.status.name() == 'PENDING'}">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-1"></i>
                    <div class="flex-grow-1">
                        <strong>이메일 인증이 필요합니다</strong>
                        <p class="mb-2 mt-1">계정의 모든 기능을 사용하시려면 이메일 인증을 완료해주세요.</p>
                        <form th:action="@{/members/resend-activation}">
                            <button class="btn btn-sm btn-warning" type="submit">
                                <i class="bi bi-envelope-fill me-1"></i>인증 이메일 재전송
                            </button>
                        </form>
                    </div>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                </div>
                <!-- Account Activation Alert END -->

                <!-- Setting Tab content START -->
                <div class="tab-content py-0 mb-0">

                    <!-- Account setting tab START -->
                    <div class="tab-pane show active fade" id="nav-setting-tab-account">
                        <!-- Success/Error Messages for Account -->
                        <div class="alert alert-success alert-dismissible fade show" role="alert"
                             th:if="${success} and ${tab == 'account'}">
                            <span th:text="${success}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                             th:if="${error} and ${tab == 'account'}">
                            <span th:text="${error}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>

                        <!-- Account settings START -->
                        <div class="card mb-4">
                            <div class="card-header border-0 pb-0">
                                <h1 class="h5 card-title">계정 설정</h1>
                                <p class="mb-0">회원님의 계정 정보를 관리하고 수정할 수 있습니다.</p>
                            </div>
                            <div class="card-body">
                                <form class="row g-3" method="post" th:action="@{/members/setting/account}">
                                    <!-- Nickname -->
                                    <div class="col-sm-6">
                                        <label class="form-label" for="nickname">닉네임</label>
                                        <input class="form-control" id="nickname" name="nickname"
                                               th:value="${member.nickname.value}"
                                               type="text">
                                    </div>
                                    <!-- Email -->
                                    <div class="col-sm-6">
                                        <label class="form-label" for="email">이메일</label>
                                        <input class="form-control" id="email" name="email" required
                                               readonly th:value="${member.email.address}" type="email">
                                    </div>
                                    <!-- Profile Address -->
                                    <div class="col-sm-6">
                                        <label class="form-label" for="profileAddress">프로필 주소</label>
                                        <input class="form-control" id="profileAddress" name="profileAddress"
                                               placeholder="프로필 주소를 입력하세요. 프로필 URL에 사용되며 중복될 수 없습니다."
                                               th:value="${member.detail.profileAddress?.address ?: ''}" type="text">
                                    </div>
                                    <!-- Introduction -->
                                    <div class="col-12">
                                        <label class="form-label" for="introduction">소개</label>
                                        <textarea class="form-control" id="introduction" maxlength="500"
                                                  name="introduction"
                                                  placeholder="자기소개를 입력하세요"
                                                  rows="4"
                                                  th:text="${member.detail.introduction?.value ?: ''}"></textarea>
                                        <small>최대 500자까지 입력 가능합니다</small>
                                    </div>
                                    <!-- Button -->
                                    <div class="col-12 text-end">
                                        <button class="btn btn-sm btn-primary mb-0" type="submit">변경사항 저장</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Account setting tab END -->

                    <!-- Change password tab START -->
                    <div class="tab-pane fade" id="nav-setting-tab-password">
                        <!-- Success/Error Messages for Password -->
                        <div class="alert alert-success alert-dismissible fade show" role="alert"
                             th:if="${success} and ${tab == 'password'}">
                            <span th:text="${success}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                             th:if="${error} and ${tab == 'password'}">
                            <span th:text="${error}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <!-- Change password START -->
                        <div class="card">
                            <div class="card-header border-0 pb-0">
                                <h5 class="card-title">비밀번호 변경</h5>
                                <p class="mb-0">계정 보안을 위해 정기적으로 비밀번호를 변경하세요.</p>
                            </div>
                            <div class="card-body">
                                <form class="row g-3" method="post" th:action="@{/members/setting/password}">
                                    <label>
                                        <input autocomplete="username"
                                               class="visually-hidden"
                                               name="username"
                                               readonly
                                               tabindex="-1"
                                               th:value="${member.email.address}"
                                               type="text">
                                    </label>
                                    <!-- Current password -->
                                    <div class="col-12">
                                        <label class="form-label" for="currentPassword">현재 비밀번호</label>
                                        <input autocomplete="current-password" class="form-control" id="currentPassword"
                                               name="currentPassword" placeholder="현재 비밀번호" required type="password">
                                    </div>
                                    <!-- New password -->
                                    <div class="col-12">
                                        <label class="form-label" for="psw-input">새 비밀번호</label>
                                        <div class="input-group">
                                            <input autocomplete="new-password" class="form-control fakepassword"
                                                   id="psw-input"
                                                   minlength="8" name="newPassword"
                                                   placeholder="새 비밀번호 입력" required type="password">
                                            <span class="input-group-text p-0">
                            <i class="fakepasswordicon fa-solid fa-eye-slash cursor-pointer p-2 w-40px"></i>
                        </span>
                                        </div>
                                    </div>
                                    <!-- Confirm password -->
                                    <div class="col-12">
                                        <label class="form-label" for="confirmNewPassword">비밀번호 확인</label>
                                        <input autocomplete="new-password" class="form-control" id="confirmNewPassword"
                                               name="confirmNewPassword" placeholder="비밀번호 재입력" required
                                               type="password">
                                    </div>
                                    <!-- Button -->
                                    <div class="col-12 text-end">
                                        <button class="btn btn-primary mb-0" type="submit">비밀번호 업데이트</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Change password tab END -->

                    <!-- Close account tab START -->
                    <div class="tab-pane fade" id="nav-setting-tab-delete">
                        <!-- Success/Error Messages for Delete -->
                        <div class="alert alert-success alert-dismissible fade show" role="alert"
                             th:if="${success} and ${tab == 'delete'}">
                            <span th:text="${success}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                             th:if="${error} and ${tab == 'delete'}">
                            <span th:text="${error}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <!-- Close account START -->
                        <div class="card">
                            <div class="card-header border-0 pb-0">
                                <h5 class="card-title">계정 삭제</h5>
                                <p class="mb-0">계정을 삭제하면 모든 데이터가 영구적으로 삭제됩니다.</p>
                            </div>
                            <div class="card-body">
                                <h6>계정을 삭제하기 전에...</h6>
                                <ul>
                                    <li>계정을 삭제하면 복구할 수 없습니다.</li>
                                </ul>
                                <form id="deleteAccountForm" method="post" th:action="@{/members/setting/delete}">
                                    <div class="form-check form-check-md my-4">
                                        <input class="form-check-input" id="deleteaccountCheck" name="confirmed"
                                               type="checkbox" value="true">
                                        <label class="form-check-label" for="deleteaccountCheck">
                                            네, 계정을 삭제하겠습니다
                                        </label>
                                    </div>
                                    <a class="btn btn-success-soft btn-sm mb-2 mb-sm-0" th:href="@{/members/setting}">
                                        계정 유지
                                    </a>
                                    <button class="btn btn-danger btn-sm mb-0"
                                            onclick="return confirm('정말로 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')"
                                            type="submit">
                                        계정 삭제
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Close account tab END -->

                </div>
                <!-- Setting Tab content END -->
            </div>

        </div> <!-- Row END -->
    </div>
    <!-- Container END -->
</main>
<!-- MAIN CONTENT END -->

<!-- Footer START -->
<footer th:replace="~{fragments/footer :: footer}"></footer>
<!-- Footer END -->

<!-- Bootstrap JS -->
<script src="/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<!-- Vendors -->
<script src="/assets/vendor/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="/assets/vendor/dropzone/dist/dropzone.js"></script>
<script src="/assets/vendor/flatpickr/dist/flatpickr.min.js"></script>

<!-- Theme Functions -->
<script src="/assets/js/functions.js"></script>

<script>
    // 탭 해시 네비게이션 스크립트
    document.addEventListener('DOMContentLoaded', function () {
        const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');

        // 탭 클릭 시 URL 해시 업데이트
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function (e) {
                const targetId = e.target.getAttribute('data-bs-target');
                if (targetId) {
                    const hash = targetId.replace('#nav-setting-tab-', '');
                    window.history.pushState(null, '', `#${hash}`);
                }
            });
        });

        // 페이지 로드 시 URL 해시에 따라 탭 활성화
        function activateTabFromHash() {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                let targetTab;

                // 해시에 따라 탭 선택
                switch (hash) {
                    case 'account':
                        targetTab = document.querySelector('[data-bs-target="#nav-setting-tab-account"]');
                        break;
                    case 'password':
                        targetTab = document.querySelector('[data-bs-target="#nav-setting-tab-password"]');
                        break;
                    case 'delete':
                        targetTab = document.querySelector('[data-bs-target="#nav-setting-tab-delete"]');
                        break;
                    default:
                        targetTab = document.querySelector('[data-bs-target="#nav-setting-tab-account"]');
                }

                if (targetTab) {
                    const tab = new bootstrap.Tab(targetTab);
                    tab.show();
                }
            }
        }

        // 초기 로드 시 탭 활성화
        activateTabFromHash();

        // 뒤로가기/앞으로가기 버튼 대응
        window.addEventListener('hashchange', activateTabFromHash);
    });
</script>

</body>

</html>
