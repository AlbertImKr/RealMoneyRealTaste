<!DOCTYPE html>
<html lang="ko">

<head>
    <title>RMRT - Settings</title>

    <!-- Meta Tags -->
    <th:block th:replace="~{fragments/meta-tags :: default-meta}"></th:block>

    <!-- Styles -->
    <th:block th:replace="~{fragments/head :: styles}"></th:block>

    <!-- Core Scripts -->
    <th:block th:replace="~{fragments/head :: core-scripts}"></th:block>
</head>

<body>

<!-- Header START -->
<header th:replace="~{fragments/header :: header}"></header>
<!-- Header END -->

<!-- MAIN CONTENT START -->
<main>
    <!-- Container START -->
    <div class="container">
        <div class="row">

            <!-- Sidenav START -->
            <div class="col-lg-3">
                <!-- Advanced filter responsive toggler START -->
                <div class="d-flex align-items-center mb-4 d-lg-none">
                    <button aria-controls="offcanvasNavbar" class="border-0 bg-transparent"
                            data-bs-target="#offcanvasNavbar"
                            data-bs-toggle="offcanvas" type="button">
                        <span class="btn btn-primary"><i class="fa-solid fa-sliders-h"></i></span>
                        <span class="h6 mb-0 fw-bold d-lg-none ms-2">설정</span>
                    </button>
                </div>
                <!-- Advanced filter responsive toggler END -->

                <nav aria-label="설정 메뉴" class="navbar navbar-light navbar-expand-lg mx-0">
                    <div aria-labelledby="offcanvasNavbarLabel" class="offcanvas offcanvas-start" id="offcanvasNavbar"
                         tabindex="-1">
                        <!-- Offcanvas header -->
                        <div class="offcanvas-header">
                            <h5 class="offcanvas-title" id="offcanvasNavbarLabel">설정 메뉴</h5>
                            <button aria-label="닫기" class="btn-close" data-bs-dismiss="offcanvas"
                                    type="button"></button>
                        </div>

                        <!-- Offcanvas body -->
                        <div class="offcanvas-body p-0">
                            <!-- Card START -->
                            <div class="card w-100">
                                <!-- Card body START -->
                                <div class="card-body">
                                    <!-- Side Nav START -->
                                    <ul class="nav nav-tabs nav-pills nav-pills-soft flex-column fw-bold gap-2 border-0">
                                        <li class="nav-item" data-bs-dismiss="offcanvas">
                                            <button class="nav-link d-flex mb-0 active border-0 w-100 text-start"
                                                    data-bs-target="#nav-setting-tab-account" data-bs-toggle="tab"
                                                    type="button">
                                                <img alt="계정 설정"
                                                     class="me-2 h-20px fa-fw"
                                                     th:src="@{/assets/images/icon/person-outline-filled.svg}">
                                                <span>계정 설정</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" data-bs-dismiss="offcanvas">
                                            <button class="nav-link d-flex mb-0 border-0 w-100 text-start"
                                                    data-bs-target="#nav-setting-tab-password" data-bs-toggle="tab"
                                                    type="button">
                                                <img alt="비밀번호 변경"
                                                     class="me-2 h-20px fa-fw"
                                                     th:src="@{/assets/images/icon/lock-outline-filled.svg}">
                                                <span>비밀번호 변경</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" data-bs-dismiss="offcanvas">
                                            <button class="nav-link d-flex mb-0 border-0 w-100 text-start"
                                                    data-bs-target="#nav-setting-tab-delete"
                                                    data-bs-toggle="tab" type="button">
                                                <img alt="계정 삭제"
                                                     class="me-2 h-20px fa-fw"
                                                     th:src="@{/assets/images/icon/trash-var-outline-filled.svg}">
                                                <span>계정 삭제</span>
                                            </button>
                                        </li>
                                    </ul>
                                    <!-- Side Nav END -->
                                </div>
                                <!-- Card body END -->
                            </div>
                            <!-- Card END -->
                        </div>
                        <!-- Offcanvas body -->

                        <!-- Copyright -->
                        <p class="small text-center mt-1">©2025 <a class="text-reset"
                                                                   href="https://github.com/AlbertImKr"
                                                                   rel="noopener" target="_blank">
                            RealMoneyRealTaste </a></p>

                    </div>
                </nav>
            </div>
            <!-- Sidenav END -->

            <!-- Main content START -->
            <div class="col-lg-6 vstack gap-4">
                <!-- Account Activation Alert START -->
                <div class="alert alert-warning alert-dismissible fade show d-flex align-items-center" role="alert"
                     th:if="${member.status.name() == 'PENDING'}">
                    <i class="bi bi-exclamation-triangle-fill me-2 fs-1"></i>
                    <div class="flex-grow-1">
                        <strong>이메일 인증이 필요합니다</strong>
                        <p class="mb-2 mt-1">계정의 모든 기능을 사용하시려면 이메일 인증을 완료해주세요.</p>
                        <form th:action="@{/members/resend-activation}">
                            <button class="btn btn-sm btn-warning" type="submit">
                                <i class="bi bi-envelope-fill me-1"></i>인증 이메일 재전송
                            </button>
                        </form>
                    </div>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                </div>
                <!-- Account Activation Alert END -->

                <!-- Setting Tab content START -->
                <div class="tab-content py-0 mb-0">

                    <!-- Account setting tab START -->
                    <div class="tab-pane show active fade" id="nav-setting-tab-account">
                        <!-- Success/Error Messages for Account -->
                        <div class="alert alert-success alert-dismissible fade show" role="alert"
                             th:if="${success} and ${tab == 'account'}">
                            <span th:text="${success}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                             th:if="${error} and ${tab == 'account'}">
                            <span th:text="${error}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>

                        <!-- Account settings START -->
                        <div class="card mb-4">
                            <div class="card-header border-0 pb-0">
                                <h1 class="h5 card-title">계정 설정</h1>
                                <p class="mb-0">회원님의 계정 정보를 관리하고 수정할 수 있습니다.</p>
                            </div>
                            <div class="card-body">
                                <form class="row g-3" id="accountUpdateForm" method="post"
                                      th:action="@{/members/setting/account}">
                                    <!-- Profile Image -->
                                    <div class="col-12">
                                        <div class="d-flex align-items-center gap-3">
                                            <!-- Current Profile Image -->
                                            <div class="profile-image-preview">
                                                <img alt="현재 프로필 이미지"
                                                     class="rounded-circle border"
                                                     style="width: 80px; height: 80px; object-fit: cover;"
                                                     th:if="${member.detail.imageId}"
                                                     th:src="@{'/api/images/' + ${member.detail.imageId}}">
                                                <div class="rounded-circle border d-flex align-items-center justify-content-center bg-light"
                                                     style="width: 80px; height: 80px;"
                                                     th:unless="${member.detail.imageId}">
                                                    <i class="bi bi-person fs-3 text-muted"></i>
                                                </div>
                                            </div>

                                            <!-- Image Upload Section -->
                                            <div class="flex-grow-1">
                                                <!-- 프로필 이미지 업로드 -->
                                                <div class="mb-2">
                                                    <!-- 이미지 업로드 컨테이너 -->
                                                    <div class="mb-2" id="profile-image-upload-container">
                                                        <!-- 업로드된 이미지 미리보기 및 URL 저장 영역 -->
                                                    </div>

                                                    <!-- 파일 선택 버튼 -->
                                                    <div class="d-flex gap-2 align-items-center">
                                                        <label class="btn btn-sm btn-outline-primary mb-0"
                                                               for="profile-image-file-input">
                                                            <i class="bi bi-upload me-1"></i> 프로필 이미지 선택
                                                        </label>
                                                        <input accept="image/jpeg,image/png,image/gif,image/webp"
                                                               class="d-none"
                                                               id="profile-image-file-input"
                                                               type="file">
                                                    </div>
                                                    <div class="form-text">JPG, PNG, GIF, WebP 형식 지원 (최대 5MB)</div>

                                                    <!-- 업로드 진행 상태 표시 -->
                                                    <div class="mt-2" id="profile-upload-progress"
                                                         style="display: none;">
                                                        <div class="progress" style="height: 20px;">
                                                            <progress
                                                                    class="progress-bar progress-bar-striped progress-bar-animated"
                                                                    id="profile-upload-progress-bar" max="100"
                                                                    value="0">
                                                                <span id="profile-upload-progress-text">0%</span>
                                                            </progress>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Nickname -->
                                    <div class="col-sm-6">
                                        <label class="form-label" for="nickname">닉네임</label>
                                        <input class="form-control" id="nickname" name="nickname"
                                               th:value="${member.nickname.value}"
                                               type="text">
                                    </div>
                                    <!-- Email -->
                                    <div class="col-sm-6">
                                        <label class="form-label" for="email">이메일</label>
                                        <input class="form-control" id="email" name="email" required
                                               readonly th:value="${member.email.address}" type="email">
                                    </div>
                                    <!-- Profile Address -->
                                    <div class="col-sm-6">
                                        <label class="form-label" for="profileAddress">프로필 주소</label>
                                        <input class="form-control" id="profileAddress" name="profileAddress"
                                               placeholder="프로필 주소를 입력하세요. 프로필 URL에 사용되며 중복될 수 없습니다."
                                               th:value="${member.detail.profileAddress?.address ?: null}" type="text">
                                    </div>
                                    <!-- Introduction -->
                                    <div class="col-12">
                                        <label class="form-label" for="introduction">소개</label>
                                        <textarea class="form-control" id="introduction" maxlength="500"
                                                  name="introduction"
                                                  placeholder="자기소개를 입력하세요"
                                                  rows="4"
                                                  th:text="${member.detail.introduction?.value ?: null}"></textarea>
                                        <small>최대 500자까지 입력 가능합니다</small>
                                    </div>
                                    <!-- Hidden field for imageId -->
                                    <input id="imageId" name="imageId" th:value="${member.detail.imageId}"
                                           type="hidden">
                                    <!-- Button -->
                                    <div class="col-12 text-end">
                                        <button class="btn btn-sm btn-primary mb-0" type="submit">변경사항 저장</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Account setting tab END -->

                    <!-- Change password tab START -->
                    <div class="tab-pane fade" id="nav-setting-tab-password">
                        <!-- Success/Error Messages for Password -->
                        <div class="alert alert-success alert-dismissible fade show" role="alert"
                             th:if="${success} and ${tab == 'password'}">
                            <span th:text="${success}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                             th:if="${error} and ${tab == 'password'}">
                            <span th:text="${error}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <!-- Change password START -->
                        <div class="card">
                            <div class="card-header border-0 pb-0">
                                <h5 class="card-title">비밀번호 변경</h5>
                                <p class="mb-0">계정 보안을 위해 정기적으로 비밀번호를 변경하세요.</p>
                            </div>
                            <div class="card-body">
                                <form class="row g-3" method="post" th:action="@{/members/setting/password}">
                                    <label>
                                        <input autocomplete="username"
                                               class="visually-hidden"
                                               name="username"
                                               readonly
                                               tabindex="-1"
                                               th:value="${member.email.address}"
                                               type="text">
                                    </label>
                                    <!-- Current password -->
                                    <div class="col-12">
                                        <label class="form-label" for="currentPassword">현재 비밀번호</label>
                                        <input autocomplete="current-password" class="form-control" id="currentPassword"
                                               name="currentPassword" placeholder="현재 비밀번호" required type="password">
                                    </div>
                                    <!-- New password -->
                                    <div class="col-12">
                                        <label class="form-label" for="psw-input">새 비밀번호</label>
                                        <div class="input-group">
                                            <input autocomplete="new-password" class="form-control fakepassword"
                                                   id="psw-input"
                                                   minlength="8" name="newPassword"
                                                   placeholder="새 비밀번호 입력" required type="password">
                                            <span class="input-group-text p-0">
                            <i class="fakepasswordicon fa-solid fa-eye-slash cursor-pointer p-2 w-40px"></i>
                        </span>
                                        </div>
                                    </div>
                                    <!-- Confirm password -->
                                    <div class="col-12">
                                        <label class="form-label" for="confirmNewPassword">비밀번호 확인</label>
                                        <input autocomplete="new-password" class="form-control" id="confirmNewPassword"
                                               name="confirmNewPassword" placeholder="비밀번호 재입력" required
                                               type="password">
                                    </div>
                                    <!-- Button -->
                                    <div class="col-12 text-end">
                                        <button class="btn btn-primary mb-0" type="submit">비밀번호 업데이트</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Change password tab END -->

                    <!-- Close account tab START -->
                    <div class="tab-pane fade" id="nav-setting-tab-delete">
                        <!-- Success/Error Messages for Delete -->
                        <div class="alert alert-success alert-dismissible fade show" role="alert"
                             th:if="${success} and ${tab == 'delete'}">
                            <span th:text="${success}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert"
                             th:if="${error} and ${tab == 'delete'}">
                            <span th:text="${error}"></span>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button"></button>
                        </div>
                        <!-- Close account START -->
                        <div class="card">
                            <div class="card-header border-0 pb-0">
                                <h5 class="card-title">계정 삭제</h5>
                                <p class="mb-0">계정을 삭제하면 모든 데이터가 영구적으로 삭제됩니다.</p>
                            </div>
                            <div class="card-body">
                                <h6>계정을 삭제하기 전에...</h6>
                                <ul>
                                    <li>계정을 삭제하면 복구할 수 없습니다.</li>
                                </ul>
                                <form id="deleteAccountForm" method="post" th:action="@{/members/setting/delete}">
                                    <div class="form-check form-check-md my-4">
                                        <input class="form-check-input" id="deleteaccountCheck" name="confirmed"
                                               type="checkbox" value="true">
                                        <label class="form-check-label" for="deleteaccountCheck">
                                            네, 계정을 삭제하겠습니다
                                        </label>
                                    </div>
                                    <a class="btn btn-success-soft btn-sm mb-2 mb-sm-0" th:href="@{/members/setting}">
                                        계정 유지
                                    </a>
                                    <button class="btn btn-danger btn-sm mb-0"
                                            onclick="return confirm('정말로 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')"
                                            type="submit">
                                        계정 삭제
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Close account tab END -->

                </div>
                <!-- Setting Tab content END -->
            </div>

        </div> <!-- Row END -->
    </div>
    <!-- Container END -->
</main>
<!-- MAIN CONTENT END -->

<!-- Footer START -->
<footer th:replace="~{fragments/footer :: footer}"></footer>
<!-- Footer END -->

<!-- Bootstrap JS -->
<script src="/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<th:block th:replace="~{fragments/scripts :: scripts}"></th:block>

<!-- Form Submit Handler -->
<script>
    document.getElementById('accountUpdateForm').addEventListener('submit', function (e) {
        // 빈 문자열인 input은 name 속성 제거 (파라미터로 전송 안됨)
        const inputs = this.querySelectorAll('input[type="text"], textarea');
        inputs.forEach(input => {
            if (input.value.trim() === '') {
                input.removeAttribute('name');
            }
        });
    });
</script>

<!-- Profile Image Upload JavaScript -->
<script th:inline="javascript">
    /**
     * 프로필 이미지 업로드 관리
     * S3 Presigned POST를 사용한 직접 업로드 방식 with CSRF 지원
     */
    class ProfileImageUploader {
        constructor() {
            this.maxFileSize = 5 * 1024 * 1024; // 5MB
            this.uploadedImage = null;
            this.isUploading = false;
            this.csrfToken = null;
            this.csrfHeader = null;

            this.init();
        }

        init() {
            // CSRF 토큰 초기화
            this.initCsrfToken();

            const fileInput = document.getElementById('profile-image-file-input');
            if (!fileInput) return;

            fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
        }

        /**
         * Spring Security CSRF 토큰 초기화
         * meta 태그에서 토큰을 읽어옴
         */
        initCsrfToken() {
            const tokenMeta = document.querySelector('meta[name="_csrf"]');
            const headerMeta = document.querySelector('meta[name="_csrf_header"]');

            if (tokenMeta && headerMeta) {
                this.csrfToken = tokenMeta.getAttribute('content');
                this.csrfHeader = headerMeta.getAttribute('content');
                console.log('CSRF 토큰 초기화 완료');
            } else {
                console.warn('CSRF meta 태그를 찾을 수 없습니다. HTML head에 추가하세요.');
            }
        }

        /**
         * CSRF 토큰을 포함한 헤더 반환
         */
        getCsrfHeaders() {
            const headers = {
                'Content-Type': 'application/json',
            };

            if (this.csrfToken && this.csrfHeader) {
                headers[this.csrfHeader] = this.csrfToken;
            }

            return headers;
        }

        handleFileSelect(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) return;

            // 프로필 이미지는 1개만 가능
            const file = files[0];

            // 파일 검증
            if (!this.validateFile(file)) {
                event.target.value = '';
                return;
            }

            this.uploadFile(file);

            // input 초기화 (같은 파일 재선택 가능하도록)
            event.target.value = '';
        }

        validateFile(file) {
            // 파일 타입 검증
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                this.showError(`${file.name}: 지원하지 않는 파일 형식입니다.`);
                return false;
            }

            // 파일 크기 검증
            if (file.size > this.maxFileSize) {
                this.showError(`${file.name}: 파일 크기는 5MB를 초과할 수 없습니다.`);
                return false;
            }

            return true;
        }

        /**
         * 이미지 파일에서 width와 height 추출
         * @param {File} file - 이미지 파일
         * @returns {Promise<{width: number, height: number}>}
         */
        async getImageDimensions(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);

                img.onload = () => {
                    URL.revokeObjectURL(url); // 메모리 해제
                    resolve({
                        width: img.naturalWidth,
                        height: img.naturalHeight
                    });
                };

                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    reject(new Error('이미지를 로드할 수 없습니다.'));
                };

                img.src = url;
            });
        }

        async uploadFile(file) {
            if (this.isUploading) return;

            this.isUploading = true;
            this.showProgress();

            try {
                // 0단계: 이미지 크기 추출
                const dimensions = await this.getImageDimensions(file);

                // 1단계: Presigned POST URL 요청 (CSRF 토큰 포함)
                const uploadRequest = await this.requestPresignedPost(file, dimensions);

                // 2단계: S3에 직접 업로드
                await this.uploadToS3(file, uploadRequest);

                // 3단계: 업로드 확인 (CSRF 토큰 포함)
                const result = await this.confirmUpload(uploadRequest.key);

                // 4단계: UI 업데이트
                this.updateProfileImagePreview(file, result);
                this.updateImageIdField(result.imageId);

            } catch (error) {
                console.error('Upload error:', error);
                this.showError(`${file.name} 업로드 실패: ${error.message}`);
            } finally {
                this.hideProgress();
                this.isUploading = false;
            }
        }

        async requestPresignedPost(file, dimensions) {
            const response = await fetch('/api/images/upload-request', {
                method: 'POST',
                headers: this.getCsrfHeaders(),
                body: JSON.stringify({
                    fileName: file.name,
                    fileSize: file.size,
                    contentType: file.type,
                    width: dimensions.width,
                    height: dimensions.height,
                    imageType: "PROFILE_IMAGE"
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Presigned URL 요청 실패');
            }

            return await response.json();
        }

        async uploadToS3(file, uploadRequest) {
            let metadata = uploadRequest.metadata
            const response = await fetch(uploadRequest.uploadUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': metadata['content-type'],
                    'x-amz-meta-content-type': metadata['content-type'],
                    'x-amz-meta-file-size': metadata['file-size'],
                    'x-amz-meta-height': metadata['height'],
                    'x-amz-meta-original-name': metadata['original-name'],
                    'x-amz-meta-width': metadata['width']
                },
                body: file
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('S3 업로드 실패:', response.status, errorText);
                throw new Error(`S3 업로드 실패: ${response.status}`);
            }
        }

        async confirmUpload(key) {
            const response = await fetch(`/api/images/upload-confirm?key=${encodeURIComponent(key)}`, {
                method: 'POST',
                headers: this.getCsrfHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || '업로드 확인 실패');
            }

            return await response.json();
        }

        updateProfileImagePreview(file, uploadResult) {
            const previewContainer = document.querySelector('.profile-image-preview');

            // FileReader로 미리보기 생성
            const reader = new FileReader();
            reader.onload = (e) => {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}"
                         alt="새 프로필 이미지"
                         class="rounded-circle border"
                         style="width: 80px; height: 80px; object-fit: cover;">
                `;
            };
            reader.readAsDataURL(file);

            // 업로드된 이미지 정보 저장
            this.uploadedImage = {
                file: file,
                imageId: uploadResult.imageId
            };

        }

        updateImageIdField(imageId) {
            const imageIdField = document.getElementById('imageId');
            if (imageIdField) {
                imageIdField.value = imageId;
            }
        }

        showProgress() {
            const progressContainer = document.getElementById('profile-upload-progress');
            if (progressContainer) {
                progressContainer.style.display = 'block';
                this.updateProgress(0);
            }
        }

        hideProgress() {
            const progressContainer = document.getElementById('profile-upload-progress');
            if (progressContainer) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    this.updateProgress(0);
                }, 500);
            }
        }

        updateProgress(percent) {
            const progressBar = document.getElementById('profile-upload-progress-bar');
            const progressText = document.getElementById('profile-upload-progress-text');

            if (progressBar) {
                progressBar.style.width = `${percent}%`;
            }
            if (progressText) {
                progressText.textContent = `${Math.round(percent)}%`;
            }
        }

        showError(message) {
            console.error(message);
            alert(message);
        }
    }

    // 전역 인스턴스 생성
    let profileImageUploader;
    document.addEventListener('DOMContentLoaded', () => {
        profileImageUploader = new ProfileImageUploader();
    });
</script>

</body>

</html>
