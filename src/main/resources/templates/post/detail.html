<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>RMRT - Í≤åÏãúÎ¨º ÏÉÅÏÑ∏</title>

    <!-- Meta Tags -->
    <th:block th:replace="~{fragments/meta-tags :: default-meta}"></th:block>

    <!-- Styles -->
    <th:block th:replace="~{fragments/head :: styles}"></th:block>

    <!-- Core Scripts -->
    <th:block th:replace="~{fragments/head :: core-scripts}"></th:block>
</head>

<body>

<!-- Header START -->
<header th:replace="~{fragments/header :: header}"></header>
<!-- Header END -->

<!-- **************** MAIN CONTENT START **************** -->
<main>

    <!-- Container START -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card card-body">
                    <!-- Post images carousel START (if multiple images) -->
                    <div hx-get="/images/carousel"
                         hx-swap="innerHTML"
                         hx-trigger="load"
                         th:attr="hx-get='/images/carousel?imageIds=' + ${#strings.listJoin(post.images.imageIds, ',')}"
                         th:if="${post.images != null and !post.images.imageIds.isEmpty()}">
                        <!-- Ïù¥ÎØ∏ÏßÄ Ï∫êÎü¨ÏÖÄÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÎê® -->
                        <div class="d-flex align-items-center justify-content-center bg-light"
                             style="height: 150px;">
                            <output class="spinner-border spinner-border-sm text-primary">
                                <span class="visually-hidden">Loading...</span>
                            </output>
                        </div>
                    </div>
                    <!-- Post images END -->

                    <!-- Feed meta START -->
                    <div class="d-flex align-items-center justify-content-between my-3">
                        <div class="d-flex align-items-center">
                            <!-- Avatar -->
                            <div class="avatar avatar-xs me-2">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                                     style="width: 32px; height: 32px;">
                                    <span class="text-white fw-bold small"
                                          th:text="${post.author.nickname.substring(0, 1).toUpperCase()}">U</span>
                                </div>
                            </div>

                            <div>
                                <div class="nav nav-divider">
                                    <h6 class="nav-item card-title mb-0">
                                        <a th:href="@{/profile/{id}(id=${post.author.memberId})}"
                                           th:text="${post.author.nickname}">ÏÇ¨Ïö©Ïûê</a>
                                    </h6>
                                    <span class="nav-item small"
                                          th:attr="data-created-at=${post.createdAt}"
                                          th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2023-10-01 12:00</span>
                                </div>
                                <p class="mb-0 small">ÏßÑÏßú ÎÇ¥ÎèàÎÇ¥ÏÇ∞ Î¶¨Î∑∞Ïñ¥ üí∞</p>
                            </div>
                        </div>

                        <!-- Card feed action dropdown START -->
                        <div class="dropdown">
                            <a aria-expanded="false" class="text-secondary btn btn-secondary-soft-hover py-1 px-2"
                               data-bs-toggle="dropdown" href="#" id="cardFeedAction">
                                <i class="bi bi-three-dots"></i>
                            </a>
                            <!-- Card feed action dropdown menu -->
                            <ul aria-labelledby="cardFeedAction" class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#"> <i class="bi bi-bookmark fa-fw pe-2"></i>Í≤åÏãúÎ¨º
                                    Ï†ÄÏû•</a></li>
                                <!-- Author only actions -->
                                <li th:if="${currentUserId == post.author.memberId}">
                                    <a class="dropdown-item" th:href="@{/posts/{id}/edit(id=${post.id})}">
                                        <i class="bi bi-pencil-square fa-fw pe-2"></i>ÏàòÏ†ïÌïòÍ∏∞
                                    </a>
                                </li>
                                <li th:if="${currentUserId == post.author.memberId}">
                                    <button class="dropdown-item"
                                            hx-confirm="Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
                                            hx-on::afterRequest="if(event.detail.xhr.status === 200) window.location.href='/'"
                                            th:attr="hx-delete='/api/posts/' + ${post.id}">
                                        <i class="bi bi-trash fa-fw pe-2"></i>ÏÇ≠Ï†úÌïòÍ∏∞
                                    </button>
                                </li>
                                <!-- Other user actions -->
                                <li th:if="${currentUserId != post.author.memberId}">
                                    <a class="dropdown-item" href="#"> <i class="bi bi-person-x fa-fw pe-2"></i>Ïñ∏ÌåîÎ°úÏö∞</a>
                                </li>
                                <li th:if="${currentUserId != post.author.memberId}">
                                    <a class="dropdown-item" href="#"> <i class="bi bi-x-circle fa-fw pe-2"></i>Í≤åÏãúÎ¨º Ïà®Í∏∞Í∏∞</a>
                                </li>
                                <li th:if="${currentUserId != post.author.memberId}">
                                    <a class="dropdown-item" href="#"> <i class="bi bi-slash-circle fa-fw pe-2"></i>Ï∞®Îã®ÌïòÍ∏∞</a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#"> <i class="bi bi-flag fa-fw pe-2"></i>Ïã†Í≥†ÌïòÍ∏∞</a>
                                </li>
                            </ul>
                        </div>
                        <!-- Card feed action dropdown END -->
                    </div>

                    <!-- Restaurant Info -->
                    <div class="mb-3">
                        <h1 class="h4 mb-2">
                            <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                            <span th:text="${post.restaurant.name}">ÎßõÏßë Ïù¥Î¶Ñ</span>
                        </h1>
                        <p class="text-muted mb-2">
                            <i class="bi bi-map me-1"></i>
                            <span th:text="${post.restaurant.address}">ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨</span>
                        </p>
                        <!-- Rating -->
                        <div class="mb-2">
							<span th:classappend="${i <= post.content.rating} ? 'bi bi-star-fill text-warning' : 'bi bi-star text-warning'"
                                  th:each="i : ${#numbers.sequence(1, 5)}"></span>
                            <span class="ms-2 text-muted" th:text="${post.content.rating} + '.0'">5.0</span>
                        </div>
                    </div>

                    <!-- Post Content -->
                    <p class="mb-3" th:text="${post.content.text}">ÏßÑÏßú ÎÇ¥ÎèàÎÇ¥ÏÇ∞ Î¶¨Î∑∞ÏûÖÎãàÎã§. Í¥ëÍ≥†ÎÇò ÌòëÏ∞¨ ÏóÜÏù¥ ÏßÅÏ†ë Î∞©Î¨∏Ìï¥ÏÑú ÏûëÏÑ±Ìïú ÏÜîÏßÅÌïú ÌõÑÍ∏∞ÏûÖÎãàÎã§.</p>

                    <!-- Feed react START -->
                    <ul class="nav nav-stack flex-wrap small mb-3">
                        <li class="nav-item">
                            <!-- HTMX Heart Toggle -->
                            <button class="nav-link btn p-0 border-0 bg-transparent"
                                    hx-swap="outerHTML"
                                    hx-target="#heart-section"
                                    th:attr="hx-post='/api/posts/' + ${post.id} + '/hearts'"
                                    th:if="${currentUserId != null}">
                                <div id="heart-section">
                                    <i class="bi bi-hand-thumbs-up-fill pe-1"></i>
                                    <span th:text="'(' + ${post.heartCount} + ')'">0</span>
                                </div>
                            </button>
                            <!-- Non-interactive heart for non-logged users -->
                            <span class="nav-link text-muted" th:if="${currentUserId == null}">
                                <i class="bi bi-hand-thumbs-up pe-1"></i>
                                <span th:text="'(' + ${post.heartCount} + ')'">0</span>
                            </span>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link text-muted">
                                <i class="bi bi-eye-fill pe-1"></i>
                                <span th:text="'Ï°∞Ìöå ' + ${post.viewCount}">Ï°∞Ìöå 0</span>
                            </span>
                        </li>
                        <!-- Card share action START -->
                        <li class="nav-item dropdown ms-sm-auto">
                            <a aria-expanded="false" class="nav-link mb-0" data-bs-toggle="dropdown" href="#"
                               id="cardShareAction">
                                <i class="bi bi-reply-fill flip-horizontal ps-1"></i>Í≥µÏú†
                            </a>
                            <!-- Card share action dropdown menu -->
                            <ul aria-labelledby="cardShareAction" class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <button class="dropdown-item"
                                            onclick="navigator.clipboard.writeText(window.location.href).then(() => alert('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.'))">
                                        <i class="bi bi-link fa-fw pe-2"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" href="#">
                                        <i class="bi bi-envelope fa-fw pe-2"></i>DMÏúºÎ°ú Í≥µÏú†
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" href="#">
                                        <i class="bi bi-share fa-fw pe-2"></i>ÌîºÎìúÏóê Í≥µÏú†
                                    </button>
                                </li>
                            </ul>
                        </li>
                        <!-- Card share action END -->
                    </ul>
                    <!-- Feed react END -->

                    <!-- Add comment form START -->
                    <div class="mt-4" th:if="${currentUserId != null}">
                        <form hx-swap="innerHTML"
                              hx-target="#comment-form-result"
                              th:attr="hx-post='/posts/' + ${post.id} + '/comments'"
                              th:id="'comment-form-' + ${post.id}">

                            <!-- CSRF ÌÜ†ÌÅ∞ÏùÑ hidden inputÏúºÎ°ú Ï≤òÎ¶¨ -->
                            <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">

                            <div class="d-flex mb-3">
                                <!-- ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê ÏïÑÎ∞îÌÉÄ -->
                                <div class="avatar avatar-xs me-2">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                                         style="width: 32px; height: 32px;">
                                        <span class="text-white fw-bold small"
                                              th:text="${currentUserNickname.substring(0, 1)?.toUpperCase() ?: 'U'}">U</span>
                                    </div>
                                </div>

                                <!-- ÎåìÍ∏Ä ÏûÖÎ†• ÏòÅÏó≠ -->
                                <div class="flex-grow-1">
                                    <textarea aria-label="ÎåìÍ∏Ä ÏûÖÎ†•"
                                              class="form-control"
                                              name="content"
                                              placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                              required
                                              rows="2"></textarea>
                                </div>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-primary btn-sm" type="submit">
                                    <i class="bi bi-send me-1"></i>ÎåìÍ∏Ä ÏûëÏÑ±
                                </button>
                            </div>
                        </form>

                        <!-- ÎåìÍ∏Ä ÏûëÏÑ± Í≤∞Í≥º Ï≤òÎ¶¨Ïö© Ïà®Í≤®ÏßÑ ÏòÅÏó≠ -->
                        <div id="comment-form-result" style="display: none;"></div>
                    </div>
                    <!-- Add comment form END -->

                    <!-- Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ -->
                    <div class="mt-4 text-center py-4 bg-light rounded" th:if="${currentUserId == null}">
                        <i class="bi bi-chat-dots text-muted mb-2" style="font-size: 2rem;"></i>
                        <p class="text-muted mb-2">ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§</p>
                        <a class="btn btn-primary btn-sm" th:href="@{/signin}">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Î°úÍ∑∏Ïù∏
                        </a>
                    </div>
                    <!-- Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ END -->

                    <!-- Comment wrap START -->
                    <div id="comments">
                        <!-- HTMXÎ°ú ÎåìÍ∏Ä Î™©Î°ù Î°úÎìú -->
                        <div hx-swap="innerHTML"
                             hx-trigger="load, reload-comments from:body"
                             th:attr="hx-get='/posts/' + ${post.id} + '/comments/fragments/list'"
                             th:id="'comments-container-' + ${post.id}">
                            <!-- Î°úÎî© ÏÉÅÌÉú -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary mb-3"></div>
                                <div class="text-muted">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                            </div>
                        </div>

                        <!-- Empty state (ÎåìÍ∏ÄÏù¥ ÏóÜÏùÑ Îïå) -->
                        <div class="text-center py-5" th:if="${commentCount == 0}">
                            <i class="bi bi-chat-dots display-4 text-muted"></i>
                            <p class="text-muted mt-3">Ï≤´ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</p>
                        </div>
                    </div>
                    <!-- Comment wrap END -->
                </div>
            </div>
        </div>
    </div>
    <!-- Container END -->

</main>
<!-- **************** MAIN CONTENT END **************** -->

<!-- Footer START -->
<footer th:replace="~{fragments/footer :: footer}"></footer>
<!-- Footer END -->

<!-- =======================
JS libraries, plugins and custom scripts -->

<!-- Bootstrap JS -->
<script src="/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>


<!-- Minimal JavaScript for essential functions -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // HTMX ÏÑ§Ï†ï
        document.body.addEventListener('htmx:configRequest', function (event) {
            // CSRF ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

            if (csrfToken && csrfHeader) {
                event.detail.headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content');
            }
        });

        // ÎåìÍ∏Ä ÏûëÏÑ± ÏÑ±Í≥µ Ï≤òÎ¶¨
        document.body.addEventListener('htmx:afterRequest', function (event) {
            const postId = /*[[${post.id}]]*/ 0;

            // ÎåìÍ∏Ä ÏûëÏÑ± ÌèºÏù∏ÏßÄ ÌôïÏù∏
            if (event.target.id === `comment-form-${postId}` && event.detail.xhr.status === 200) {
                // 1. Ìèº Ï¥àÍ∏∞Ìôî
                event.target.reset();

                // 2. ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                showSuccessMessage(event.target);

                // 3. ÎåìÍ∏Ä Î™©Î°ù Îã§Ïãú Î°úÎìú
                setTimeout(() => {
                    reloadComments(postId);
                }, 100);
            }
        });

        // ÏóêÎü¨ Ï≤òÎ¶¨
        document.body.addEventListener('htmx:responseError', function (event) {
            console.error('HTMX Error:', event.detail);
            if (event.detail.xhr.status === 403) {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                window.location.href = '/signin';
            } else if (event.detail.xhr.status >= 400) {
                alert('ÏöîÏ≤≠ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        });
    });

    // ÎåìÍ∏Ä Î™©Î°ù Îã§Ïãú Î°úÎìúÌïòÎäî Ìï®Ïàò
    function reloadComments(postId) {
        const commentsContainer = document.querySelector(`#comments-container-${postId}`);
        if (commentsContainer) {
            // HTMXÎ°ú ÎåìÍ∏Ä Î™©Î°ù Îã§Ïãú Î°úÎìú
            htmx.trigger(commentsContainer, 'reload-comments');

            // ÎåìÍ∏Ä Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            updateCommentCount(postId);
        }
    }

    function updateCommentCount(postId) {
        // Ïû†Ïãú ÌõÑ DOMÏù¥ ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌõÑ ÎåìÍ∏Ä ÏàòÎ•º Í≥ÑÏÇ∞
        setTimeout(() => {
            const commentsContainer = document.querySelector(`#comments-container-${postId}`);
            if (commentsContainer) {
                const commentItems = commentsContainer.querySelectorAll('.comment-item');
                const totalCountDisplay = document.getElementById('comment-count-display');

                if (totalCountDisplay) {
                    totalCountDisplay.textContent = commentItems.length;
                }
            }
        }, 500);
    }

    function showSuccessMessage(form) {
        const textarea = form.querySelector('textarea[name="content"]');
        if (textarea) {
            const originalPlaceholder = textarea.placeholder;
            textarea.placeholder = 'ÎåìÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§!';
            textarea.style.borderColor = '#28a745';
            setTimeout(() => {
                textarea.placeholder = originalPlaceholder;
                textarea.style.borderColor = '';
            }, 2000);
        }
    }
</script>

<!-- Scripts -->
<th:block th:replace="~{fragments/scripts :: scripts}"></th:block>

</body>
</html>
