<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>RMRT - Í≤åÏãúÎ¨º ÏÉÅÏÑ∏</title>

    <!-- Meta Tags -->
    <th:block th:replace="~{fragments/meta-tags :: default-meta}"></th:block>

    <!-- Dark mode -->
    <th:block th:insert="~{fragments/darkmode :: darkmode-script}"></th:block>

    <!-- Favicon -->
    <link href="/assets/images/favicon.ico" rel="shortcut icon">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Plugins CSS -->
    <link href="/assets/vendor/font-awesome/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" type="text/css">

    <!-- Theme CSS -->
    <link href="/assets/css/style.css" rel="stylesheet" type="text/css">

</head>

<body>

<!-- Header START -->
<header th:replace="~{fragments/header :: header}"></header>
<!-- Header END -->

<!-- **************** MAIN CONTENT START **************** -->
<main>

    <!-- Container START -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card card-body">
                    <!-- Post images carousel START (if multiple images) -->
                    <div class="position-relative" th:if="${post.images != null && !post.images.isEmpty()}">
                        <div th:if="${post.images.size() == 1}">
                            <!-- Single image -->
                            <img alt="ÎßõÏßë ÏÇ¨ÏßÑ" class="card-img rounded" th:src="${post.images.urls[0]}">
                        </div>
                        <div class="carousel slide" data-bs-ride="carousel" id="postImageCarousel"
                             th:if="${post.images.size() > 1}">
                            <!-- Carousel indicators -->
                            <div class="carousel-indicators">
                                <button th:attr="aria-current=${iterStat.first} ? 'true' : 'false'"
                                        th:classappend="${iterStat.first} ? 'active' : ''"
                                        th:data-bs-slide-to="${iterStat.index}"
                                        th:data-bs-target="'#postImageCarousel'"
                                        th:each="img, iterStat : ${post.images.urls}"
                                        type="button">
                                </button>
                            </div>
                            <!-- Carousel inner -->
                            <div class="carousel-inner rounded">
                                <div class="carousel-item"
                                     th:classappend="${iterStat.first} ? 'active' : ''"
                                     th:each="img, iterStat : ${post.images.urls}">
                                    <img alt="ÎßõÏßë ÏÇ¨ÏßÑ" class="d-block w-100 rounded" th:src="${img}">
                                </div>
                            </div>
                            <!-- Carousel controls -->
                            <button class="carousel-control-prev" data-bs-slide="prev" data-bs-target="#postImageCarousel"
                                    type="button">
                                <span aria-hidden="true" class="carousel-control-prev-icon"></span>
                                <span class="visually-hidden">Ïù¥Ï†Ñ</span>
                            </button>
                            <button class="carousel-control-next" data-bs-slide="next" data-bs-target="#postImageCarousel"
                                    type="button">
                                <span aria-hidden="true" class="carousel-control-next-icon"></span>
                                <span class="visually-hidden">Îã§Ïùå</span>
                            </button>
                        </div>
                    </div>
                    <!-- Post images END -->

                    <!-- Feed meta START -->
                    <div class="d-flex align-items-center justify-content-between my-3">
                        <div class="d-flex align-items-center">
                            <div>
                                <div class="nav nav-divider">
                                    <h6 class="nav-item card-title mb-0">
                                        <a th:href="@{/profile/{id}(id=${post.author.memberId})}"
                                           th:text="${post.author.nickname}">ÏÇ¨Ïö©Ïûê</a>
                                    </h6>
                                    <span class="nav-item small"
                                          th:attr="data-created-at=${post.createdAt}"
                                          th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2023-10-01 12:00</span>
                                </div>
                                <p class="mb-0 small">ÏßÑÏßú ÎÇ¥ÎèàÎÇ¥ÏÇ∞ Î¶¨Î∑∞Ïñ¥ üí∞</p>
                            </div>
                        </div>

                        <!-- Card feed action dropdown START -->
                        <div class="dropdown">
                            <a aria-expanded="false" class="text-secondary btn btn-secondary-soft-hover py-1 px-2"
                               data-bs-toggle="dropdown" href="#" id="cardFeedAction">
                                <i class="bi bi-three-dots"></i>
                            </a>
                            <!-- Card feed action dropdown menu -->
                            <ul aria-labelledby="cardFeedAction" class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#"> <i class="bi bi-bookmark fa-fw pe-2"></i>Í≤åÏãúÎ¨º
                                    Ï†ÄÏû•</a></li>
                                <!-- Author only actions -->
                                <li th:if="${currentUserId == post.author.memberId}">
                                    <a class="dropdown-item" th:href="@{/posts/{id}/edit(id=${post.id})}">
                                        <i class="bi bi-pencil-square fa-fw pe-2"></i>ÏàòÏ†ïÌïòÍ∏∞
                                    </a>
                                </li>
                                <li th:if="${currentUserId == post.author.memberId}">
                                    <button class="dropdown-item" href="#" onclick="deletePost()">
                                        <i class="bi bi-trash fa-fw pe-2"></i>ÏÇ≠Ï†úÌïòÍ∏∞
                                    </button>
                                </li>
                                <!-- Other user actions -->
                                <li th:if="${currentUserId != post.author.memberId}">
                                    <a class="dropdown-item" href="#"> <i class="bi bi-person-x fa-fw pe-2"></i>Ïñ∏ÌåîÎ°úÏö∞</a>
                                </li>
                                <li th:if="${currentUserId != post.author.memberId}">
                                    <a class="dropdown-item" href="#"> <i class="bi bi-x-circle fa-fw pe-2"></i>Í≤åÏãúÎ¨º Ïà®Í∏∞Í∏∞</a>
                                </li>
                                <li th:if="${currentUserId != post.author.memberId}">
                                    <a class="dropdown-item" href="#"> <i class="bi bi-slash-circle fa-fw pe-2"></i>Ï∞®Îã®ÌïòÍ∏∞</a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#"> <i class="bi bi-flag fa-fw pe-2"></i>Ïã†Í≥†ÌïòÍ∏∞</a>
                                </li>
                            </ul>
                        </div>
                        <!-- Card feed action dropdown END -->
                    </div>

                    <!-- Restaurant Info -->
                    <div class="mb-3">
                        <h1 class="h4 mb-2">
                            <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                            <span th:text="${post.restaurant.name}">ÎßõÏßë Ïù¥Î¶Ñ</span>
                        </h1>
                        <p class="text-muted mb-2">
                            <i class="bi bi-map me-1"></i>
                            <span th:text="${post.restaurant.address}">ÏÑúÏö∏Ïãú Í∞ïÎÇ®Íµ¨</span>
                        </p>
                        <!-- Rating -->
                        <div class="mb-2">
							<span th:classappend="${i <= post.content.rating} ? 'bi bi-star-fill text-warning' : 'bi bi-star text-warning'"
                                  th:each="i : ${#numbers.sequence(1, 5)}"></span>
                            <span class="ms-2 text-muted" th:text="${post.content.rating} + '.0'">5.0</span>
                        </div>
                    </div>

                    <!-- Post Content -->
                    <p class="mb-3" th:text="${post.content.text}">ÏßÑÏßú ÎÇ¥ÎèàÎÇ¥ÏÇ∞ Î¶¨Î∑∞ÏûÖÎãàÎã§. Í¥ëÍ≥†ÎÇò ÌòëÏ∞¨ ÏóÜÏù¥ ÏßÅÏ†ë Î∞©Î¨∏Ìï¥ÏÑú ÏûëÏÑ±Ìïú ÏÜîÏßÅÌïú ÌõÑÍ∏∞ÏûÖÎãàÎã§.</p>

                    <!-- Feed react START -->
                    <ul class="nav nav-stack flex-wrap small mb-3">
                        <li class="nav-item">
                            <button class="nav-link" href="#" onclick="toggleHeart()">
                                <i class="bi bi-hand-thumbs-up-fill pe-1"></i>
                                <span id="heartCount" th:text="'(' + ${post.heartCount} + ')'">0</span>
                            </button>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#comments">
                                <i class="bi bi-chat-fill pe-1"></i>
                                <span th:text="'(' + ${commentCount} + ')'">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-muted">
                                <i class="bi bi-eye-fill pe-1"></i>
                                <span th:text="'Ï°∞Ìöå ' + ${post.viewCount}">Ï°∞Ìöå 0</span>
                            </a>
                        </li>
                        <!-- Card share action START -->
                        <li class="nav-item dropdown ms-sm-auto">
                            <a aria-expanded="false" class="nav-link mb-0" data-bs-toggle="dropdown" href="#"
                               id="cardShareAction">
                                <i class="bi bi-reply-fill flip-horizontal ps-1"></i>Í≥µÏú†
                            </a>
                            <!-- Card share action dropdown menu -->
                            <ul aria-labelledby="cardShareAction" class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <button class="dropdown-item" href="#" onclick="shareViaDM()"><i
                                            class="bi bi-envelope fa-fw pe-2"></i>DMÏúºÎ°ú Í≥µÏú†
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" href="#" onclick="copyLink()"><i
                                            class="bi bi-link fa-fw pe-2"></i>ÎßÅÌÅ¨ Î≥µÏÇ¨
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" href="#" onclick="shareToFeed()"><i
                                            class="bi bi-share fa-fw pe-2"></i>ÌîºÎìúÏóê Í≥µÏú†
                                    </button>
                                </li>
                            </ul>
                        </li>
                        <!-- Card share action END -->
                    </ul>
                    <!-- Feed react END -->

                    <!-- Comment wrap START -->
                    <div id="comments">
                        <h5 class="mb-3" th:if="${comments != null && !comments.isEmpty()}">
                            ÎåìÍ∏Ä <span th:text="${commentCount}">0</span>
                        </h5>
                        <ul class="comment-wrap list-unstyled" th:if="${comments != null && !comments.isEmpty()}">
                            <!-- Comment item START -->
                            <li class="comment-item" th:each="comment : ${comments}">
                                <div class="d-flex position-relative">
                                    <!-- Avatar -->
                                    <div class="avatar avatar-xs">
                                        <a th:href="@{/profile/{id}(id=${comment.authorId})}">
                                            <img alt="ÌîÑÎ°úÌïÑ"
                                                 class="avatar-img rounded-circle avatar-fallback"
                                                 th:src="@{/api/members/{id}/avatar(id=${comment.authorId})}">
                                        </a>
                                    </div>
                                    <div class="ms-2 w-100">
                                        <!-- Comment by -->
                                        <div class="bg-light rounded-start-top-0 p-3 rounded">
                                            <div class="d-flex justify-content-between">
                                                <h6 class="mb-1">
                                                    <a th:href="@{/profile/{id}(id=${comment.authorId})}"
                                                       th:text="${comment.authorName}">ÏÇ¨Ïö©Ïûê</a>
                                                </h6>
                                                <small class="ms-2"
                                                       th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">5ÏãúÍ∞Ñ
                                                    Ï†Ñ</small>
                                            </div>
                                            <p class="small mb-0" th:text="${comment.content}">Ï†ïÎßê ÎßõÏûàÏóàÏñ¥Ïöî!</p>
                                        </div>
                                        <!-- Comment react -->
                                        <ul class="nav nav-divider py-2 small">
                                            <li class="nav-item">
                                                <a class="nav-link" href="#">
                                                    Ï¢ãÏïÑÏöî (<span th:text="${comment.likeCount}">3</span>)
                                                </a>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" href="#"> ÎãµÍ∏Ä</a>
                                            </li>
                                            <li class="nav-item" th:if="${comment.replyCount > 0}">
                                                <a class="nav-link" href="#">
                                                    ÎãµÍ∏Ä <span th:text="${comment.replyCount}">5</span>Í∞ú Î≥¥Í∏∞
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </li>
                            <!-- Comment item END -->
                        </ul>

                        <!-- Empty state -->
                        <div class="text-center py-5" th:if="${comments == null || comments.isEmpty()}">
                            <i class="bi bi-chat-dots display-4 text-muted"></i>
                            <p class="text-muted mt-3">Ï≤´ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</p>
                        </div>

                        <!-- Load more comments button -->
                        <div class="text-center mt-3" th:if="${hasMoreComments}">
                            <button class="btn btn-link btn-link-loader btn-sm text-secondary d-flex align-items-center justify-content-center"
                                    href="#"
                                    onclick="loadMoreComments()">
                                <div class="spinner-dots me-2">
                                    <span class="spinner-dot"></span>
                                    <span class="spinner-dot"></span>
                                    <span class="spinner-dot"></span>
                                </div>
                                ÎåìÍ∏Ä ÎçîÎ≥¥Í∏∞
                            </button>
                        </div>
                    </div>
                    <!-- Comment wrap END -->

                    <!-- Add comment form START -->
                    <div class="mt-4" th:if="${currentUserId != null}">
                        <form id="commentForm" onsubmit="submitComment(event)">
                            <div class="d-flex mb-3">
                                <label class="form-label visually-hidden" for="commentText">ÎåìÍ∏Ä ÏûÖÎ†•</label>
                                <textarea class="form-control" id="commentText" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." required
                                          rows="2"></textarea>
                            </div>
                            <button class="btn btn-primary btn-sm" type="submit">ÎåìÍ∏Ä ÏûëÏÑ±</button>
                        </form>
                    </div>
                    <!-- Add comment form END -->
                </div>
            </div>
        </div>
    </div>
    <!-- Container END -->

</main>
<!-- **************** MAIN CONTENT END **************** -->

<!-- Footer START -->
<footer th:replace="~{fragments/footer :: footer}"></footer>
<!-- Footer END -->

<!-- =======================
JS libraries, plugins and custom scripts -->

<!-- Bootstrap JS -->
<script src="/assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<!-- Theme Functions -->
<script src="/assets/js/functions.js"></script>

<!-- Post Detail Functions -->
<script th:inline="javascript">
    const postId = /*[[${post.id}]]*/ 0;
    const currentUserId = /*[[${currentUserId}]]*/ null;

    // Handle avatar image loading errors
    document.addEventListener('DOMContentLoaded', function () {
        const avatarImages = document.querySelectorAll('.avatar-fallback');
        avatarImages.forEach(img => {
            img.addEventListener('error', function () {
                this.src = '/assets/images/avatar/default.jpg';
            });
        });
    });

    // Toggle heart
    function toggleHeart() {
        if (!currentUserId) {
            alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
            window.location.href = '/signin';
            return;
        }

        fetch(`/api/posts/${postId}/hearts`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('heartCount').textContent = `(${data.heartCount})`;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
    }

    // Delete post
    function deletePost() {
        if (confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
            })
                .then(response => {
                    if (response.ok) {
                        alert('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                        window.location.href = '/';
                    } else {
                        alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                });
        }
    }

    // Submit comment
    function submitComment(event) {
        event.preventDefault();

        const commentText = document.getElementById('commentText').value;

        fetch(`/api/posts/${postId}/comments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({content: commentText})
        })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            });
    }

    // Copy link
    function copyLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
        });
    }

    // Load more comments
    function loadMoreComments() {
        // Implement pagination logic
        console.log('Load more comments');
    }

    /*]]>*/

    document.addEventListener('DOMContentLoaded', function () {
        function updateRelativeTime() {
            document.querySelectorAll('[data-created-at]').forEach(function (element) {
                const createdAt = new Date(element.getAttribute('data-created-at'));
                const now = new Date();
                const diffMs = now - createdAt;
                const diffMinutes = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                const diffYears = Math.floor(diffDays / 365);

                let relativeTime;

                if (diffMinutes < 1) {
                    relativeTime = 'Î∞©Í∏à Ï†Ñ';
                } else if (diffMinutes < 60) {
                    relativeTime = diffMinutes + 'Î∂Ñ Ï†Ñ';
                } else if (diffHours < 24) {
                    relativeTime = diffHours + 'ÏãúÍ∞Ñ Ï†Ñ';
                } else if (diffDays < 365) {
                    relativeTime = diffDays + 'Ïùº Ï†Ñ';
                } else {
                    relativeTime = diffYears + 'ÎÖÑ Ï†Ñ';
                }

                element.textContent = relativeTime;
            });
        }

        updateRelativeTime();
        // 1Î∂ÑÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
        setInterval(updateRelativeTime, 60000);
    });
</script>
</body>
</html>
