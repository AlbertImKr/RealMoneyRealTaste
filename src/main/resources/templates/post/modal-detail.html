<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Post Detail Modal Fragment</title>
</head>
<body>

<!-- Post Detail Modal Content Fragment -->
<div th:fragment="post-detail-modal">
    <div class="card card-body">
        <!-- Post images carousel START (if multiple images) -->
        <div class="position-relative" th:if="${post.images != null && !post.images.isEmpty()}">
            <div th:if="${post.images.size() == 1}">
                <!-- Single image -->
                <img alt="맛집 사진" class="card-img rounded" th:src="${post.images.urls[0]}">
            </div>
            <div class="carousel slide" data-bs-ride="carousel" id="postImageCarousel"
                 th:if="${post.images.size() > 1}">
                <!-- Carousel indicators -->
                <div class="carousel-indicators">
                    <button th:attr="aria-current=${iterStat.first} ? 'true' : 'false'"
                            th:classappend="${iterStat.first} ? 'active' : ''"
                            th:data-bs-slide-to="${iterStat.index}"
                            th:data-bs-target="'#postImageCarousel'"
                            th:each="img, iterStat : ${post.images.urls}"
                            type="button">
                    </button>
                </div>
                <!-- Carousel inner -->
                <div class="carousel-inner rounded">
                    <div class="carousel-item"
                         th:classappend="${iterStat.first} ? 'active' : ''"
                         th:each="img, iterStat : ${post.images.urls}">
                        <img alt="맛집 사진" class="d-block w-100 rounded" th:src="${img}">
                    </div>
                </div>
                <!-- Carousel controls -->
                <button class="carousel-control-prev" data-bs-slide="prev"
                        data-bs-target="#postImageCarousel"
                        type="button">
                    <span aria-hidden="true" class="carousel-control-prev-icon"></span>
                    <span class="visually-hidden">이전</span>
                </button>
                <button class="carousel-control-next" data-bs-slide="next"
                        data-bs-target="#postImageCarousel"
                        type="button">
                    <span aria-hidden="true" class="carousel-control-next-icon"></span>
                    <span class="visually-hidden">다음</span>
                </button>
            </div>
        </div>
        <!-- Post images END -->

        <!-- Feed meta START -->
        <div class="d-flex align-items-center justify-content-between my-3">
            <div class="d-flex align-items-center">
                <!-- Avatar -->
                <div class="avatar avatar-xs me-2">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 32px; height: 32px;">
                                    <span class="text-white fw-bold small"
                                          th:text="${post.author.nickname.substring(0, 1).toUpperCase()}">U</span>
                    </div>
                </div>

                <div>
                    <div class="nav nav-divider">
                        <h6 class="nav-item card-title mb-0">
                            <a th:href="@{/profile/{id}(id=${post.author.memberId})}"
                               th:text="${post.author.nickname}">사용자</a>
                        </h6>
                        <span class="nav-item small"
                              th:attr="data-created-at=${post.createdAt}"
                              th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2023-10-01 12:00</span>
                    </div>
                    <p class="mb-0 small">진짜 내돈내산 리뷰어 💰</p>
                </div>
            </div>

            <!-- Card feed action dropdown START -->
            <div class="dropdown">
                <a aria-expanded="false" class="text-secondary btn btn-secondary-soft-hover py-1 px-2"
                   data-bs-toggle="dropdown" href="#" id="cardFeedAction">
                    <i class="bi bi-three-dots"></i>
                </a>
                <!-- Card feed action dropdown menu -->
                <ul aria-labelledby="cardFeedAction" class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#"> <i class="bi bi-bookmark fa-fw pe-2"></i>게시물
                        저장</a></li>
                    <!-- Author only actions -->
                    <li th:if="${currentUserId == post.author.memberId}">
                        <a class="dropdown-item" th:href="@{/posts/{id}/edit(id=${post.id})}">
                            <i class="bi bi-pencil-square fa-fw pe-2"></i>수정하기
                        </a>
                    </li>
                    <li th:if="${currentUserId == post.author.memberId}">
                        <button class="dropdown-item"
                                hx-confirm="정말 삭제하시겠습니까?"
                                hx-on::afterRequest="if(event.detail.xhr.status === 200) window.location.href='/'"
                                th:attr="hx-delete='/api/posts/' + ${post.id}">
                            <i class="bi bi-trash fa-fw pe-2"></i>삭제하기
                        </button>
                    </li>
                    <!-- Other user actions -->
                    <li th:if="${currentUserId != post.author.memberId}">
                        <a class="dropdown-item" href="#"> <i class="bi bi-person-x fa-fw pe-2"></i>언팔로우</a>
                    </li>
                    <li th:if="${currentUserId != post.author.memberId}">
                        <a class="dropdown-item" href="#"> <i class="bi bi-x-circle fa-fw pe-2"></i>게시물 숨기기</a>
                    </li>
                    <li th:if="${currentUserId != post.author.memberId}">
                        <a class="dropdown-item" href="#"> <i class="bi bi-slash-circle fa-fw pe-2"></i>차단하기</a>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li><a class="dropdown-item" href="#"> <i class="bi bi-flag fa-fw pe-2"></i>신고하기</a>
                    </li>
                </ul>
            </div>
            <!-- Card feed action dropdown END -->
        </div>

        <!-- Restaurant Info -->
        <div class="mb-3">
            <h1 class="h4 mb-2">
                <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                <span th:text="${post.restaurant.name}">맛집 이름</span>
            </h1>
            <p class="text-muted mb-2">
                <i class="bi bi-map me-1"></i>
                <span th:text="${post.restaurant.address}">서울시 강남구</span>
            </p>
            <!-- Rating -->
            <div class="mb-2">
							<span th:classappend="${i <= post.content.rating} ? 'bi bi-star-fill text-warning' : 'bi bi-star text-warning'"
                                  th:each="i : ${#numbers.sequence(1, 5)}"></span>
                <span class="ms-2 text-muted" th:text="${post.content.rating} + '.0'">5.0</span>
            </div>
        </div>

        <!-- Post Content -->
        <p class="mb-3" th:text="${post.content.text}">진짜 내돈내산 리뷰입니다. 광고나 협찬 없이 직접 방문해서 작성한 솔직한 후기입니다.</p>

        <!-- Feed react START -->
        <ul class="nav nav-stack flex-wrap small mb-3">
            <li class="nav-item">
                <!-- HTMX Heart Toggle -->
                <button class="nav-link btn p-0 border-0 bg-transparent"
                        hx-swap="outerHTML"
                        hx-target="#heart-section"
                        th:attr="hx-post='/api/posts/' + ${post.id} + '/hearts'"
                        th:if="${currentUserId != null}">
                    <div id="heart-section">
                        <i class="bi bi-hand-thumbs-up-fill pe-1"></i>
                        <span th:text="'(' + ${post.heartCount} + ')'">0</span>
                    </div>
                </button>
                <!-- Non-interactive heart for non-logged users -->
                <span class="nav-link text-muted" th:if="${currentUserId == null}">
                                <i class="bi bi-hand-thumbs-up pe-1"></i>
                                <span th:text="'(' + ${post.heartCount} + ')'">0</span>
                            </span>
            </li>
            <li class="nav-item">
                            <span class="nav-link text-muted">
                                <i class="bi bi-eye-fill pe-1"></i>
                                <span th:text="'조회 ' + ${post.viewCount}">조회 0</span>
                            </span>
            </li>
            <!-- Card share action START -->
            <li class="nav-item dropdown ms-sm-auto">
                <a aria-expanded="false" class="nav-link mb-0" data-bs-toggle="dropdown" href="#"
                   id="cardShareAction">
                    <i class="bi bi-reply-fill flip-horizontal ps-1"></i>공유
                </a>
                <!-- Card share action dropdown menu -->
                <ul aria-labelledby="cardShareAction" class="dropdown-menu dropdown-menu-end">
                    <li>
                        <button class="dropdown-item"
                                onclick="navigator.clipboard.writeText(window.location.href).then(() => alert('링크가 복사되었습니다.'))">
                            <i class="bi bi-link fa-fw pe-2"></i>링크 복사
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" href="#">
                            <i class="bi bi-envelope fa-fw pe-2"></i>DM으로 공유
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" href="#">
                            <i class="bi bi-share fa-fw pe-2"></i>피드에 공유
                        </button>
                    </li>
                </ul>
            </li>
            <!-- Card share action END -->
        </ul>
        <!-- Feed react END -->


        <!-- Add comment form START -->
        <div class="mt-4" th:if="${currentUserId != null}">
            <form hx-swap="innerHTML"
                  hx-target="#comment-form-result"
                  th:attr="hx-post='/posts/' + ${post.id} + '/comments'"
                  th:id="'comment-form-' + ${post.id}">

                <!-- CSRF 토큰을 hidden input으로 처리 -->
                <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">

                <div class="d-flex mb-3">
                    <!-- 현재 사용자 아바타 -->
                    <div class="avatar avatar-xs me-2">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                             style="width: 32px; height: 32px;">
                                        <span class="text-white fw-bold small"
                                              th:text="${currentUserNickname.substring(0, 1)?.toUpperCase() ?: 'U'}">U</span>
                        </div>
                    </div>

                    <!-- 댓글 입력 영역 -->
                    <div class="flex-grow-1">
                                    <textarea aria-label="댓글 입력"
                                              class="form-control"
                                              name="content"
                                              placeholder="댓글을 입력하세요..."
                                              required
                                              rows="2"></textarea>
                    </div>
                </div>
                <div class="text-end">
                    <button class="btn btn-primary btn-sm" type="submit">
                        <i class="bi bi-send me-1"></i>댓글 작성
                    </button>
                </div>
            </form>

            <!-- 댓글 작성 결과 처리용 숨겨진 영역 -->
            <div id="comment-form-result" style="display: none;"></div>
        </div>
        <!-- Add comment form END -->

        <!-- 로그인하지 않은 경우 -->
        <div class="mt-4 text-center py-4 bg-light rounded" th:if="${currentUserId == null}">
            <i class="bi bi-chat-dots text-muted mb-2" style="font-size: 2rem;"></i>
            <p class="text-muted mb-2">댓글을 작성하려면 로그인이 필요합니다</p>
            <a class="btn btn-primary btn-sm" th:href="@{/signin}">
                <i class="bi bi-box-arrow-in-right me-1"></i>로그인
            </a>
        </div>

        <!-- Comment wrap START -->
        <div id="comments">
            <!-- HTMX로 댓글 목록 로드 -->
            <div hx-swap="innerHTML"
                 hx-trigger="load, reload-comments from:body"
                 th:attr="hx-get='/posts/' + ${post.id} + '/comments/fragments/list'"
                 th:id="'comments-container-' + ${post.id}">
                <!-- 로딩 상태 -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3"></div>
                    <div class="text-muted">댓글을 불러오는 중...</div>
                </div>
            </div>

            <!-- Empty state (댓글이 없을 때) -->
            <div class="text-center py-5" th:if="${commentCount == 0}">
                <i class="bi bi-chat-dots display-4 text-muted"></i>
                <p class="text-muted mt-3">첫 댓글을 남겨보세요!</p>
            </div>
        </div>
        <!-- Comment wrap END -->
    </div>
    <!-- Modal-specific JavaScript -->
    <script th:inline="javascript">
        function addCsrfToken() {
            return function (event) {
                // CSRF 토큰 추가
                const csrfToken = document.querySelector('meta[name="_csrf"]');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]');

                if (csrfToken && csrfHeader) {
                    event.detail.headers[csrfHeader.getAttribute('content')] = csrfToken.getAttribute('content');
                }
            };
        }

        // HTMX 설정
        document.body.addEventListener('htmx:configRequest', addCsrfToken());

        function handleCommentFormSuccess() {
            return function (event) {
                const postId = /*[[${post.id}]]*/ 0
                // 댓글 작성 폼인지 확인
                if (event.target.id === `comment-form-${postId}` && event.detail.xhr.status === 200) {
                    // 1. 폼 초기화
                    event.target.reset();

                    // 2. 성공 메시지 표시
                    showSuccessMessage(event.target);

                    // 3. 댓글 목록 다시 로드
                    setTimeout(() => {
                        reloadComments(postId);
                    }, 100);
                }
            };
        }

        // 댓글 작성 성공 처리
        document.body.addEventListener('htmx:afterRequest', handleCommentFormSuccess());

        // 댓글 목록 다시 로드하는 함수
        function reloadComments(postId) {
            const commentsContainer = document.querySelector(`#comments-container-${postId}`);
            if (commentsContainer) {
                // HTMX로 댓글 목록 다시 로드
                htmx.trigger(commentsContainer, 'reload-comments');

                // 댓글 수 업데이트
                updateCommentCount(postId);
            }
        }

        function updateCommentCount(postId) {
            // 잠시 후 DOM이 업데이트된 후 댓글 수를 계산
            setTimeout(() => {
                const commentsContainer = document.querySelector(`#comments-container-${postId}`);
                if (commentsContainer) {
                    const commentItems = commentsContainer.querySelectorAll('.comment-item');
                    const totalCountDisplay = document.getElementById('comment-count-display');

                    if (totalCountDisplay) {
                        totalCountDisplay.textContent = commentItems.length;
                    }
                }
            }, 500);
        }

        function showSuccessMessage(form) {
            const textarea = form.querySelector('textarea[name="content"]');
            if (textarea) {
                const originalPlaceholder = textarea.placeholder;
                textarea.placeholder = '댓글이 작성되었습니다!';
                textarea.style.borderColor = '#28a745';
                setTimeout(() => {
                    textarea.placeholder = originalPlaceholder;
                    textarea.style.borderColor = '';
                }, 2000);
            }
        }
    </script>
</div>

</body>
</html>
