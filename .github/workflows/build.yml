name: CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2'
  JAVA_VERSION: '21'
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  ECR_REPOSITORY: rmrt-app
  IMAGE_TAG: ${{ github.sha }}
  SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
  SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
  SPRING_MAIL_HOST: ${{ secrets.SPRING_MAIL_HOST }}
  SPRING_MAIL_PORT: ${{ secrets.SPRING_MAIL_PORT }}
  APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  check-src-changes:
    name: src ë³€ê²½ í™•ì¸
    runs-on: ubuntu-latest
    outputs:
      has_src_changes: ${{ steps.check.outputs.changes }}
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: src ë³€ê²½ í™•ì¸
        id: check
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^src/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: ë‹¨ìœ„ ë° í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test --continue

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¬¼ ì €ì¥
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results
          path: |
            build/reports/
            build/test-results/
  build:
    name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•œë‹¤
        run: ./gradlew build -x test --build-cache

  sonarqube:
    name: ì½”ë“œ í’ˆì§ˆ ë¶„ì„
    runs-on: ubuntu-latest
    needs: [ test ]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # SonarQube needs full history

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: SonarQube íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v5
        with:
          name: test-results
          path: build/

      - name: SonarQube ë¶„ì„ ì‹¤í–‰
        run: ./gradlew sonar --build-cache --info

  docker-build-and-deploy:
    name: Docker ë¹Œë“œ ë° ECS ë°°í¬
    runs-on: ubuntu-latest
    needs: [ check-src-changes, test, build, sonarqube ]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.check-src-changes.outputs.has_src_changes == 'true'
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .

      - name: Docker ì´ë¯¸ì§€ ECRì— í‘¸ì‹œ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
        run: |
          # ê¸°ì¡´ íƒœìŠ¤í¬ ì •ì˜ë¡œ ê°•ì œ ì¬ë°°í¬ 
          TASK_DEFINITION_ARN=$(aws ecs describe-task-definition --task-definition rmrt-task --query 'taskDefinition.taskDefinitionArn' --output text)
          
          aws ecs update-service \
            --cluster rmrt-cluster-ec2version \
            --service rmrt-task-service-o4qq7b02 \
            --task-definition $TASK_DEFINITION_ARN \
            --force-new-deployment
          
          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸° (íƒ€ì„ì•„ì›ƒ ì„¤ì • ì¶”ê°€)
          echo "â³ ECS ë°°í¬ ì™„ë£Œ ëŒ€ê¸°..."
          timeout 300 aws ecs wait services-stable \
            --cluster rmrt-cluster-ec2version \
            --services rmrt-task-service-o4qq7b02 || \
          echo "âš ï¸ ë°°í¬ ì•ˆì •í™” ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ (ì‹¤ì œ ë°°í¬ëŠ” ì„±ê³µí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
          
          echo "âœ… ECS ë°°í¬ ì™„ë£Œ!"

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          aws ecs describe-services \
            --cluster rmrt-cluster-ec2version \
            --services rmrt-task-service-o4qq7b02 \
            --query 'services[0].{status: status, runningCount: runningCount, desiredCount: desiredCount}'
          
          echo "ğŸŒ ì‹¤ì œ ë„ë©”ì¸: https://rmrt.albert-im.com"
          echo "ğŸ” ë„ë©”ì¸ í—¬ìŠ¤ ì²´í¬: https://rmrt.albert-im.com/actuator/health"
