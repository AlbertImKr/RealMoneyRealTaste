name: CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches:
      - main
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2'
  JAVA_VERSION: '21'
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  ECR_REPOSITORY: rmrt-app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  test:
    name: ë‹¨ìœ„ ë° í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test -Dspring.profiles.active=test --continue
  build:
    name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•œë‹¤
        run: ./gradlew build -x test --build-cache

  sonarqube:
    name: ì½”ë“œ í’ˆì§ˆ ë¶„ì„
    runs-on: ubuntu-latest
    needs: [ test, build ]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # SonarQube needs full history

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: SonarQube íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: SonarQube ë¶„ì„ ì‹¤í–‰
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew sonar --build-cache --info

  docker-build-and-deploy:
    name: Docker ë¹Œë“œ ë° ECS ë°°í¬
    runs-on: ubuntu-latest
    needs: [ test, build, sonarqube ]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2.0.1

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .

      - name: Docker ì´ë¯¸ì§€ ECRì— í‘¸ì‹œ
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: ê¸°ì¡´ íƒœìŠ¤í¬ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
        run: |
          aws ecs describe-task-definition --task-definition rmrt-task > task-definition-current.json

      - name: íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ë§Œ ë³€ê²½)
        run: |
          # ê¸°ì¡´ íƒœìŠ¤í¬ ì •ì˜ì—ì„œ ì´ë¯¸ì§€ë§Œ ì—…ë°ì´íŠ¸
          NEW_IMAGE="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"
          
          # jqë¡œ ì´ë¯¸ì§€ URI ì—…ë°ì´íŠ¸
          jq '.containerDefinitions[0].image = "'$NEW_IMAGE'"' task-definition-current.json > task-definition-updated.json
          
          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          aws ecs register-task-definition \
            --cli-input-json file://task-definition-updated.json

      - name: ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
        run: |
          # ìµœì‹  íƒœìŠ¤í¬ ì •ì˜ë¡œ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
          TASK_DEFINITION_ARN=$(aws ecs describe-task-definition --task-definition rmrt-task --query 'taskDefinition.taskDefinitionArn' --output text)
          
          aws ecs update-service \
            --cluster rmrt-cluster \
            --service rmrt-service \
            --task-definition $TASK_DEFINITION_ARN \
            --force-new-deployment
          
          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          echo "â³ ECS ë°°í¬ ì™„ë£Œ ëŒ€ê¸°..."
          aws ecs wait services-stable \
            --cluster rmrt-cluster \
            --services rmrt-service
          
          echo "âœ… ECS ë°°í¬ ì™„ë£Œ!"

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          aws ecs describe-services \
            --cluster rmrt-cluster \
            --services rmrt-service \
            --query 'services[0].{status: status, runningCount: runningCount, desiredCount: desiredCount}'
          
          # ALB DNS ì´ë¦„ ì¶œë ¥
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --names rmrt-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text)
          
          echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://$ALB_DNS"
          echo "ğŸ” í—¬ìŠ¤ ì²´í¬: http://$ALB_DNS/actuator/health"
