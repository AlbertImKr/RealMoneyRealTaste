name: CI/CD íŒŒì´í”„ë¼ì¸ (OCI Rolling ë°°í¬)

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2'
  JAVA_VERSION: '21'
  SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
  SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
  SPRING_MAIL_HOST: ${{ secrets.SPRING_MAIL_HOST }}
  SPRING_MAIL_PORT: ${{ secrets.SPRING_MAIL_PORT }}
  APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  check-src-changes:
    name: src ë³€ê²½ í™•ì¸
    runs-on: ubuntu-latest
    outputs:
      has_src_changes: ${{ steps.check.outputs.changes }}
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: src ë³€ê²½ í™•ì¸
        id: check
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^src/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: ë‹¨ìœ„ ë° í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test --continue

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¬¼ ì €ì¥
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results
          path: |
            build/reports/
            build/test-results/

  build:
    name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•œë‹¤
        run: ./gradlew build -x test --build-cache

  sonarqube:
    name: ì½”ë“œ í’ˆì§ˆ ë¶„ì„
    runs-on: ubuntu-latest
    needs: [ test ]
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # SonarQube needs full history

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: SonarQube íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v5
        with:
          name: test-results
          path: build/

      - name: SonarQube ë¶„ì„ ì‹¤í–‰
        run: ./gradlew sonar --build-cache --info

  docker-build-and-push:
    name: Docker ë¹Œë“œ ë° OCIR í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: [ check-src-changes, test, build, sonarqube ]

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: OCIR ë¡œê·¸ì¸
        env:
          OCI_AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_TENANCY: ${{ secrets.OCI_TENANCY }}
          OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
        run: |
          docker login "$OCI_REGION.ocir.io" \
            -u "${OCI_TENANCY}/${OCI_USERNAME}" \
            --password-stdin <<< "$OCI_AUTH_TOKEN"

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        env:
          OCI_REGISTRY: ${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY }}
        run: |
          docker build -t $OCI_REGISTRY/rmrt-app:${{ github.sha }} .
          docker tag $OCI_REGISTRY/rmrt-app:${{ github.sha }} \
            $OCI_REGISTRY/rmrt-app:latest

      - name: Docker ì´ë¯¸ì§€ OCIRì— í‘¸ì‹œ
        timeout-minutes: 30
        env:
          OCI_REGISTRY: ${{ secrets.OCI_REGION }}.ocir.io/${{ secrets.OCI_TENANCY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $OCI_REGISTRY/rmrt-app --all-tags

  deploy-server-1:
    name: Server 1 ë°°í¬
    runs-on: ubuntu-latest
    needs: [ docker-build-and-push ]

    steps:
      - name: Server 1ì— ë°°í¬
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0
        env:
          OCI_AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_TENANCY: ${{ secrets.OCI_TENANCY }}
          OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
          DB_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          DB_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          DB_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SPRING_MAIL_HOST: ${{ secrets.SPRING_MAIL_HOST }}
          SPRING_MAIL_PORT: ${{ secrets.SPRING_MAIL_PORT }}
          SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
          SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
        with:
          host: ${{ secrets.OCI_VM_IP_1 }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_KEY_1 }}
          envs: OCI_AUTH_TOKEN,OCI_REGION,OCI_TENANCY,OCI_USERNAME,DB_URL,DB_USERNAME,DB_PASSWORD,SPRING_MAIL_HOST,SPRING_MAIL_PORT,SPRING_MAIL_USERNAME,SPRING_MAIL_PASSWORD,APP_BASE_URL
          script: |
            echo "ğŸš€ Server 1 ë°°í¬ ì‹œì‘..."
            
            # OCIR ë¡œê·¸ì¸
            sudo docker login ${OCI_REGION}.ocir.io \
              -u "${OCI_TENANCY}/${OCI_USERNAME}" \
              --password-stdin <<< "$OCI_AUTH_TOKEN"
            
            # ìµœì‹  ì´ë¯¸ì§€ í’€
            sudo docker pull ${OCI_REGION}.ocir.io/${OCI_TENANCY}/rmrt-app:latest
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            sudo docker stop rmrt-app || true
            sudo docker rm rmrt-app || true
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            sudo docker run -d \
              --name rmrt-app \
              --restart unless-stopped \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e SPRING_DATASOURCE_URL="${DB_URL}" \
              -e SPRING_DATASOURCE_USERNAME="${DB_USERNAME}" \
              -e SPRING_DATASOURCE_PASSWORD="${DB_PASSWORD}" \
              -e SPRING_MAIL_HOST="${SPRING_MAIL_HOST}" \
              -e SPRING_MAIL_PORT="${SPRING_MAIL_PORT}" \
              -e SPRING_MAIL_USERNAME="${SPRING_MAIL_USERNAME}" \
              -e SPRING_MAIL_PASSWORD="${SPRING_MAIL_PASSWORD}" \
              -e APP_BASE_URL="${APP_BASE_URL}" \
              ${OCI_REGION}.ocir.io/${OCI_TENANCY}/rmrt-app:latest
            
            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            sudo docker image prune -f

      - name: Server 1 í—¬ìŠ¤ì²´í¬
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0
        with:
          host: ${{ secrets.OCI_VM_IP_1 }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_KEY_1 }}
          script: |
            echo "â³ Server 1 í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°..."
            for i in {1..24}; do
              if curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; then
                echo "âœ… Server 1 í—¬ìŠ¤ì²´í¬ í†µê³¼!"
                exit 0
              fi
              echo "ëŒ€ê¸° ì¤‘... ($i/24)"
              sleep 5
            done
            echo "âŒ Server 1 í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            exit 1

  deploy-server-2:
    name: Server 2 ë°°í¬
    runs-on: ubuntu-latest
    needs: [ deploy-server-1 ]

    steps:
      - name: Server 2ì— ë°°í¬
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0
        env:
          OCI_AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          OCI_TENANCY: ${{ secrets.OCI_TENANCY }}
          OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
          DB_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
          DB_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
          DB_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SPRING_MAIL_HOST: ${{ secrets.SPRING_MAIL_HOST }}
          SPRING_MAIL_PORT: ${{ secrets.SPRING_MAIL_PORT }}
          SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
          SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
        with:
          host: ${{ secrets.OCI_VM_IP_2 }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_KEY_2 }}
          envs: OCI_AUTH_TOKEN,OCI_REGION,OCI_TENANCY,OCI_USERNAME,DB_URL,DB_USERNAME,DB_PASSWORD,SPRING_MAIL_HOST,SPRING_MAIL_PORT,SPRING_MAIL_USERNAME,SPRING_MAIL_PASSWORD,APP_BASE_URL
          script: |
            echo "ğŸš€ Server 2 ë°°í¬ ì‹œì‘..."
            
            # OCIR ë¡œê·¸ì¸
            sudo docker login ${OCI_REGION}.ocir.io \
              -u "${OCI_TENANCY}/${OCI_USERNAME}" \
              --password-stdin <<< "$OCI_AUTH_TOKEN"
            
            # ìµœì‹  ì´ë¯¸ì§€ í’€
            sudo docker pull ${OCI_REGION}.ocir.io/${OCI_TENANCY}/rmrt-app:latest
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            sudo docker stop rmrt-app || true
            sudo docker rm rmrt-app || true
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            sudo docker run -d \
              --name rmrt-app \
              --restart unless-stopped \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e SPRING_DATASOURCE_URL="${DB_URL}" \
              -e SPRING_DATASOURCE_USERNAME="${DB_USERNAME}" \
              -e SPRING_DATASOURCE_PASSWORD="${DB_PASSWORD}" \
              -e SPRING_MAIL_HOST="${SPRING_MAIL_HOST}" \
              -e SPRING_MAIL_PORT="${SPRING_MAIL_PORT}" \
              -e SPRING_MAIL_USERNAME="${SPRING_MAIL_USERNAME}" \
              -e SPRING_MAIL_PASSWORD="${SPRING_MAIL_PASSWORD}" \
              -e APP_BASE_URL="${APP_BASE_URL}" \
              ${OCI_REGION}.ocir.io/${OCI_TENANCY}/rmrt-app:latest
            
            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
            sudo docker image prune -f

      - name: Server 2 í—¬ìŠ¤ì²´í¬
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0
        with:
          host: ${{ secrets.OCI_VM_IP_2 }}
          username: ubuntu
          key: ${{ secrets.OCI_SSH_KEY_2 }}
          script: |
            echo "â³ Server 2 í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°..."
            for i in {1..24}; do
              if curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; then
                echo "âœ… Server 2 í—¬ìŠ¤ì²´í¬ í†µê³¼!"
                exit 0
              fi
              echo "ëŒ€ê¸° ì¤‘... ($i/24)"
              sleep 5
            done
            echo "âŒ Server 2 í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            exit 1

  verify-deployment:
    name: ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [ deploy-server-2 ]

    steps:
      - name: Load Balancer í—¬ìŠ¤ì²´í¬
        env:
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          OCI_LB_IP: ${{ secrets.OCI_LB_IP }}
        run: |
          echo "ğŸ” Load Balancer í†µí•´ ì„œë¹„ìŠ¤ í™•ì¸..."
          for i in {1..6}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${APP_BASE_URL}/actuator/health || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘!"
              echo ""
              echo "ğŸŒ ì„œë¹„ìŠ¤ URL: ${OCI_LB_IP}"
              echo "ğŸ” í—¬ìŠ¤ì²´í¬: ${OCI_LB_IP}/actuator/health"
              exit 0
            fi
            echo "ëŒ€ê¸° ì¤‘... ($i/6) - HTTP $RESPONSE"
            sleep 10
          done
          echo "âš ï¸ Load Balancer ì‘ë‹µ í™•ì¸ í•„ìš”"
          exit 0
