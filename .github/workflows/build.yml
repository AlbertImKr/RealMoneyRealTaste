name: CI/CD íŒŒì´í”„ë¼ì¸ (GCP MIG ìë™ ë°°í¬)

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2'
  JAVA_VERSION: '21'
  SPRING_MAIL_USERNAME: ${{ secrets.SPRING_MAIL_USERNAME }}
  SPRING_MAIL_PASSWORD: ${{ secrets.SPRING_MAIL_PASSWORD }}
  SPRING_MAIL_HOST: ${{ secrets.SPRING_MAIL_HOST }}
  SPRING_MAIL_PORT: ${{ secrets.SPRING_MAIL_PORT }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  GCP_ARTIFACT_REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/rmrt-repo
  APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  check-src-changes:
    name: src ë³€ê²½ í™•ì¸
    runs-on: ubuntu-latest
    outputs:
      has_src_changes: ${{ steps.check.outputs.changes }}
    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: src ë³€ê²½ í™•ì¸
        id: check
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^src/'; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: ë‹¨ìœ„ ë° í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¬¼ ì €ì¥
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: test-results
          path: |
            build/reports/
            build/test-results/

  build:
    name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•œë‹¤
        run: ./gradlew build -x test --build-cache

  sonarqube:
    name: ì½”ë“œ í’ˆì§ˆ ë¶„ì„
    runs-on: ubuntu-latest
    needs: [ test ]
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # SonarQube needs full history

      - name: ìë°”ë¥¼ ì„¤ì¹˜í•œë‹¤
        uses: actions/setup-java@v5
        with:
          distribution: 'corretto'
          java-version: ${{ env.JAVA_VERSION }}

      - name: SonarQube íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Gradle íŒ¨í‚¤ì§€ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v5
        with:
          name: test-results
          path: build/

      - name: SonarQube ë¶„ì„ ì‹¤í–‰
        run: ./gradlew sonar --build-cache --info

  docker-build-and-push:
    name: Docker ë¹Œë“œ ë° Artifact Registry í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: [ check-src-changes, test, build, sonarqube ]
    #    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.check-src-changes.outputs.has_src_changes == 'true'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•œë‹¤
        uses: actions/checkout@v6

      - name: GCP ì¸ì¦ (Workload Identity Federation)
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Cloud SDK ì„¤ì •
        uses: google-github-actions/setup-gcloud@v3

      - name: Artifact Registry ì¸ì¦
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
        run: |
          gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        env:
          GCP_ARTIFACT_REGISTRY: ${{ env.GCP_ARTIFACT_REGISTRY }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          docker build -t ${GCP_ARTIFACT_REGISTRY}/rmrt-app:${GITHUB_SHA} .
          docker tag ${GCP_ARTIFACT_REGISTRY}/rmrt-app:${GITHUB_SHA} \
            ${GCP_ARTIFACT_REGISTRY}/rmrt-app:latest

      - name: Docker ì´ë¯¸ì§€ Artifact Registryì— í‘¸ì‹œ
        timeout-minutes: 30
        env:
          GCP_ARTIFACT_REGISTRY: ${{ env.GCP_ARTIFACT_REGISTRY }}
        run: |
          docker push ${GCP_ARTIFACT_REGISTRY}/rmrt-app --all-tags

  deploy-mig:
    name: MIG Rolling Update ë°°í¬
    runs-on: ubuntu-latest
    needs: [ docker-build-and-push ]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: GCP ì¸ì¦
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Cloud SDK ì„¤ì •
        uses: google-github-actions/setup-gcloud@v3

      - name: MIG Rolling Update ì‹œì‘
        env:
          INSTANCE_TEMPLATE: ${{ secrets.GCP_INSTANCE_TEMPLATE }}
          GCP_REGION: ${{ env.GCP_REGION }}
        run: |
          echo "ğŸš€ MIG Rolling Update ì‹œì‘..."
          gcloud compute instance-groups managed rolling-action start-update rmrt-mig \
            --version template=${INSTANCE_TEMPLATE} \
            --region=${GCP_REGION} \
            --max-surge=1 \
            --max-unavailable=0

      - name: MIG Update ì™„ë£Œ ëŒ€ê¸°
        timeout-minutes: 15
        env:
          GCP_REGION: ${{ env.GCP_REGION }}
        run: |
          echo "â³ MIG Rolling Update ì™„ë£Œ ëŒ€ê¸°..."
          gcloud compute instance-groups managed wait-until rmrt-mig \
            --version-target-reached \
            --region=${GCP_REGION} \
            --timeout=900

  verify-deployment:
    name: ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    needs: [ deploy-mig ]

    steps:
      - name: Load Balancer í—¬ìŠ¤ì²´í¬
        env:
          APP_BASE_URL: ${{ env.APP_BASE_URL }}
        run: |
          echo "ğŸ” Load Balancer í†µí•´ ì„œë¹„ìŠ¤ í™•ì¸..."
          for i in {1..6}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${APP_BASE_URL}/actuator/health || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘!"
              echo ""
              echo "ğŸŒ ì„œë¹„ìŠ¤ URL: ${APP_BASE_URL}"
              echo "ğŸ” í—¬ìŠ¤ì²´í¬: ${APP_BASE_URL}/actuator/health"
              exit 0
            fi
            echo "ëŒ€ê¸° ì¤‘... ($i/6) - HTTP $RESPONSE"
            sleep 10
          done
          echo "âš ï¸ Load Balancer ì‘ë‹µ í™•ì¸ í•„ìš”"
          exit 0
